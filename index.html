<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ù†Ø¸Ø§Ù… ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† â€” (Excel Ø£ÙˆØ±Ø§Ù‚ Ù…Ù†ÙØµÙ„Ø©)</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#f8f9f8; --card:#ffffff; --emerald-dark:#080b18; --emerald:#281987; --emerald-2:#362ea2;
    --table-head:#e9f5ec; --muted:#4f5d52; --danger:#d9534f; --gold-highlight:#fff7e6;
    --gold-border: rgba(255,170,0,0.12); --shadow: 0 10px 30px rgba(15,81,50,0.06); --radius:10px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);font-family:'Cairo',sans-serif;color:#071123;line-height:1.5;
    -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
  }
  
  /* LOGIN SCREEN */
  #loginScreen {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: linear-gradient(135deg, var(--emerald), var(--emerald-dark));
    z-index: 10000; display: flex; align-items: center; justify-content: center;
    flex-direction: column;
  }
  .login-card {
    background: #fff; padding: 30px; border-radius: 15px; width: 90%; max-width: 400px;
    box-shadow: 0 20px 50px rgba(0,0,0,0.2); text-align: center;
  }
  .login-input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; font-family: 'Cairo'; outline:none; }
  .login-btn { width: 100%; padding: 12px; background: var(--emerald); color: #fff; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
  .login-error { color: var(--danger); display: none; font-weight:bold; margin-top:10px;}

  /* MAIN APP */
  .container{max-width:1200px;margin:18px auto;padding:18px; display:none;}
  .header{display:flex;justify-content:space-between;align-items:center;gap:12px;padding:16px 18px;border-radius:var(--radius);
          background: linear-gradient(90deg,var(--emerald),var(--emerald-2));color:#fff;box-shadow: var(--shadow);}
  .header .title{font-weight:900;font-size:1.05rem;}
  .nav{display:flex;gap:8px;flex-wrap:wrap;margin-top:14px;}
  .nav button{background:transparent;border:0;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:800;color:var(--emerald-dark);}
  .nav button:hover{transform:translateY(-3px);color:var(--emerald);}
  .nav button.active{background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,255,255,0.86)); box-shadow: 0 8px 18px rgba(15,81,50,0.06);}
  .card{background:var(--card);padding:14px;border-radius:var(--radius);margin-top:12px;box-shadow: 0 8px 26px rgba(10,25,18,0.03);border: 1px solid rgba(15,81,50,0.03);}
  .btn{display:inline-flex;gap:8px;align-items:center;justify-content:center;padding:9px 14px;border-radius:9px;border:0;cursor:pointer;font-weight:800;color:#fff;background: linear-gradient(90deg,var(--emerald),var(--emerald-2));box-shadow: 0 8px 20px rgba(15,81,50,0.08);transition: transform 180ms, box-shadow 180ms;}
  .btn:hover{transform: translateY(-4px);}
  .btn.ghost{background: transparent;color: var(--emerald-dark);border:1px solid rgba(15,81,50,0.06);box-shadow:none;}
  .btn.danger{background: linear-gradient(90deg,#e64a3c,#d9534f);color:#fff;}
  input,select,textarea{width:100%;padding:10px 12px;border-radius:8px;border:1px solid #e6efe8;background: linear-gradient(180deg, #fff, #fbfdfb);outline:none;}
  table{width:100%;border-collapse:collapse;margin-top:10px;font-size:0.95rem;overflow:auto;}
  .table th, .table td{padding:10px;text-align:right;vertical-align:middle;border-bottom:1px solid #f1f6f1;}
  .table th{background:var(--table-head);font-weight:900;color:var(--emerald-dark);position:sticky;top:0;z-index:2;}
  .small{ font-size:13px;color:var(--muted) }
  .toast{position:fixed;top:18px;right:18px;padding:12px 16px;border-radius:10px;background: linear-gradient(90deg,var(--emerald),var(--emerald-2));color:#fff;font-weight:800;display:none;z-index:9999;box-shadow: 0 8px 28px rgba(15,81,50,0.12);}
  
  .filter-box { background: #f1f6f1; padding: 12px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #e0e0e0; }
  .filter-row { display: flex; gap: 10px; align-items: flex-end; flex-wrap: wrap; }
  .filter-row > div { flex: 1; min-width: 150px; }

  /* Checkboxes */
  input[type="checkbox"] { appearance: none; width: 24px; height: 24px; border: 2px solid #bbb; border-radius: 6px; display: inline-block; position: relative; cursor: pointer; vertical-align: middle; margin-left: 6px; background:#fff; }
  input[type="checkbox"]:checked { border-color: #d9534f; background-color: #ffe5e5; }
  input[type="checkbox"]:checked::after { content: "âœ–"; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -52%); font-size: 16px; color: #d9534f; font-weight: bold; }
  input[type="checkbox"].chk-positive:checked { border-color: var(--emerald); background-color: #e9f5ec; }
  input[type="checkbox"].chk-positive:checked::after { content: "âœ”"; color: var(--emerald); font-size: 18px; }
  input:disabled { background-color: #eee; color: #999; cursor: not-allowed; }

  /* Report Styles */
  .report-wrap { border:1px solid #eee; padding:20px; border-radius:8px; background:#fff; margin-top:10px; }
  .report-header { display:flex; justify-content:space-between; border-bottom:3px solid var(--emerald); padding-bottom:15px; margin-bottom:20px; align-items: flex-end;}
  .section { margin-top:20px; }
  .section h4 { border-right:4px solid var(--emerald); padding-right:10px; color:var(--emerald-dark); margin-bottom:10px; font-size:1.1rem; }
  .kpi { display:flex; gap:15px; margin-top:10px; flex-wrap:wrap; }
  .card-kpi { background:#f4f9f6; padding:10px 15px; border-radius:8px; text-align:center; min-width:100px; border:1px solid rgba(15,81,50,0.1); }

  /* PRINT MEDIA QUERY */
  @media print {
    .header, .nav, .filter-box, .btn, #loginScreen { display: none !important; }
    .container { margin: 0; padding: 0; max-width: 100%; }
    .card { border: 0; box-shadow: none; padding: 0; margin: 0; }
    .report-wrap { border: 0; padding: 0; margin: 0; }
    body { background: #fff; }
    .report-page { page-break-after: always; }
  }
</style>
</head>
<body>

<!-- Login -->
<div id="loginScreen">
  <div class="login-card">
    <div style="font-size:3rem;margin-bottom:10px">ğŸ“</div>
    <div style="font-weight:900;font-size:1.4rem;color:var(--emerald-dark);margin-bottom:20px">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</div>
    <input type="text" id="login_user" class="login-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (user name)">
    <input type="password" id="login_pass" class="login-input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (password)">
    <button id="doLogin" class="login-btn">Ø¯Ø®ÙˆÙ„</button>
    <div id="loginError" class="login-error">Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø§Ø·Ø¦Ø©</div>
  </div>
</div>

<!-- Main App -->
<div class="container" id="appContainer">

  <header class="header">
    <div class="title">ğŸ“ Ù†Ø¸Ø§Ù… ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†</div>
    <div style="display:flex;gap:8px;align-items:center">
      <button id="logoutBtn" class="btn danger" style="padding:6px 10px; font-size:0.9rem">Ø®Ø±ÙˆØ¬</button>
      <button id="backupTop" class="btn ghost">ğŸ’¾</button>
    </div>
  </header>

  <nav class="nav" id="mainNav">
    <button class="nav-btn" data-screen="teachers">Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†</button>
    <button class="nav-btn" data-screen="criteria">Ø¨Ù†ÙˆØ¯ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</button>
    <button class="nav-btn" data-screen="daily">Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„ÙŠÙˆÙ…ÙŠ</button>
    <button class="nav-btn" data-screen="weekly">Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ</button>
    <button class="nav-btn" data-screen="monthly">Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø´Ù‡Ø±ÙŠ</button>
    <button class="nav-btn" data-screen="attendance">Ø§Ù„Ø­Ø¶ÙˆØ±</button>
    <button class="nav-btn" data-screen="absences">Ø§Ù„ØºÙŠØ§Ø¨</button>
    <button class="nav-btn" data-screen="summaryReport">ğŸ“Š Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø®ØªØµØ±</button>
    <button class="nav-btn" data-screen="fullReport">Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ø§Ù…Ù„</button>
    <button class="nav-btn" data-screen="settings">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
    <button class="nav-btn" data-screen="teacherReport">ğŸ“„ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ù…ÙØµÙ‘Ù„</button>
  </nav>

  <!-- Teachers -->
  <section id="teachers" class="card screen" style="display:none">
    <h3>Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†</h3>
    
    <div class="row">
      <div><label class="small">Ø§Ù„Ø§Ø³Ù…</label><input id="t_name"></div>
      <div><label class="small">Ø§Ù„Ø±Ù‚Ù…</label><input id="t_id"></div>
    </div>
    <div class="row" style="margin-top:8px">
      <div><label class="small">Ø§Ù„Ù…Ø§Ø¯Ø©</label><input id="t_subject"></div>
      <div><label class="small">Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</label><input id="t_email" placeholder="example@mail.com"></div>
    </div>

    <div style="margin-top:8px;display:flex;gap:8px">
      <button id="addTeacher" class="btn">Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„Ù‘Ù…</button>
      <input type="file" id="importFile" accept=".xlsx,.xls,.csv" style="display:none">
      <button id="btnImportFile" class="btn ghost">ğŸ“‚ ØªØ­Ù…ÙŠÙ„ Ù…Ù† Excel/CSV</button>
    </div>
    <div style="margin-top:12px">
      <table class="table" id="teachersTable"><thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø±Ù‚Ù…</th><th>Ø§Ù„Ù…Ø§Ø¯Ø©</th><th>Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</th><th>Ø¹Ù…Ù„ÙŠØ§Øª</th></tr></thead><tbody></tbody></table>
    </div>
  </section>

  <!-- Criteria -->
  <section id="criteria" class="card screen" style="display:none">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3>Ø¨Ù†ÙˆØ¯ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</h3>
      <button id="restoreDefaults" class="btn ghost">ğŸ”„ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ</button>
    </div>
    <div style="margin-top:12px">
      <div class="row">
        <div><label class="small">Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ø¯</label><input id="ci_name" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„ØªØ­Ø¶ÙŠØ±"></div>
        <div><label class="small">Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¹Ù„Ù‰</label><input id="ci_max" type="number" min="1" value="10"></div>
        <div><label class="small">Ù†ÙˆØ¹ Ø§Ù„Ø¨Ù†Ø¯</label><select id="ci_kind"><option value="daily">ÙŠÙˆÙ…ÙŠ</option><option value="weekly">Ø£Ø³Ø¨ÙˆØ¹ÙŠ</option><option value="monthly">Ø´Ù‡Ø±ÙŠ</option></select></div>
        <div><label class="small">Ù‚ÙŠÙ…Ø© Ø§Ù„Ø®ØµÙ…</label><input id="ci_penalty" type="number" min="0" step="0.1" value="1"></div>
      </div>
      <div style="margin-top:8px">
        <label class="small">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø§Ø­ØªØ³Ø§Ø¨:</label>
        <select id="ci_logic" style="background:#f0f8ff; border-color:#b0c4de;">
          <option value="negative">ØªØ³Ø¬ÙŠÙ„ Ù…Ø®Ø§Ù„ÙØ§Øª (ØµØ­ âœ– = Ø®ØµÙ…)</option>
          <option value="positive">ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ±/Ø§Ù„ØªØ²Ø§Ù… (ØµØ­ âœ” = Ø¹Ø¯Ù… Ø®ØµÙ…)</option>
        </select>
      </div>
      <div style="margin-top:12px"><button id="addCi" class="btn">â• Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯ Ø¬Ø¯ÙŠØ¯</button></div>
      <div style="margin-top:12px"><table class="table" id="ci_table"><thead><tr><th>Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ø¯</th><th>Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø§Ø­ØªØ³Ø§Ø¨</th><th>Ø§Ù„Ø®ØµÙ…</th><th>Ø¹Ù…Ù„ÙŠØ§Øª</th></tr></thead><tbody></tbody></table></div>
    </div>
  </section>

  <!-- DAILY -->
  <section id="daily" class="card screen" style="display:none">
    <h3>Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„ÙŠÙˆÙ…ÙŠ</h3>
    <div class="row" style="margin-top:8px; margin-bottom:12px"><div><label class="small">Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input id="daily_date" type="date"></div></div>
    <div style="background:#fff; border:1px solid #eee; padding:10px; border-radius:8px;"><div id="daily_table_wrap"></div></div>
    <div style="margin-top:15px;display:flex;gap:8px; border-top:1px solid #eee; padding-top:10px;"><button id="saveDaily" class="btn">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</button></div>
    <div style="margin-top:20px"><h4 style="margin-bottom:5px; color:var(--emerald-dark)">Ø³Ø¬Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© (Ø§Ù„ÙŠÙˆÙ…ÙŠØ©)</h4><table class="table" id="daily_sessions_table"><thead id="daily_head"></thead><tbody id="daily_body"></tbody></table></div>
  </section>

  <!-- WEEKLY -->
  <section id="weekly" class="card screen" style="display:none">
    <h3>Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ</h3>
    <div class="row" style="margin-top:8px; margin-bottom:12px"><div><label class="small">Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input id="weekly_date" type="date"></div></div>
    <div style="background:#fff; border:1px solid #eee; padding:10px; border-radius:8px;"><div id="weekly_table_wrap"></div></div>
    <div style="margin-top:15px;display:flex;gap:8px; border-top:1px solid #eee; padding-top:10px;"><button id="saveWeekly" class="btn">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</button></div>
    <div style="margin-top:20px"><h4 style="margin-bottom:5px; color:var(--emerald-dark)">Ø³Ø¬Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© (Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©)</h4><table class="table" id="weekly_sessions_table"><thead id="weekly_head"></thead><tbody id="weekly_body"></tbody></table></div>
  </section>

  <!-- MONTHLY -->
  <section id="monthly" class="card screen" style="display:none">
    <h3>Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø´Ù‡Ø±ÙŠ</h3>
    <div class="row" style="margin-top:8px; margin-bottom:12px"><div><label class="small">Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input id="monthly_date" type="date"></div></div>
    <div style="background:#fff; border:1px solid #eee; padding:10px; border-radius:8px;"><div id="monthly_table_wrap"></div></div>
    <div style="margin-top:15px;display:flex;gap:8px; border-top:1px solid #eee; padding-top:10px;"><button id="saveMonthly" class="btn">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</button></div>
    <div style="margin-top:20px"><h4 style="margin-bottom:5px; color:var(--emerald-dark)">Ø³Ø¬Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© (Ø§Ù„Ø´Ù‡Ø±ÙŠØ©)</h4><table class="table" id="monthly_sessions_table"><thead id="monthly_head"></thead><tbody id="monthly_body"></tbody></table></div>
  </section>

  <!-- Attendance -->
  <section id="attendance" class="card screen" style="display:none">
    <h3>Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø§Ù†ØµØ±Ø§Ù</h3>
    <label class="small">Ø§Ø®ØªØ± Ù…Ø¹Ù„Ù‘Ù…</label><select id="attendance_teacher"></select>
    <div class="row" style="margin-top:8px">
      <div><label class="small">Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input id="att_date" type="date"></div>
      <div><label class="small">ÙˆÙ‚Øª Ø§Ù„Ø­Ø¶ÙˆØ±</label><input id="att_arrival" type="time" value="07:00"></div>
      <div><label class="small">ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØµØ±Ø§Ù</label><input id="att_leave" type="time" value="13:25"></div>
    </div>
    <div style="margin-top:8px"><button id="saveAttendance" class="btn">Ø­ÙØ¸</button><button id="clearAttendance" class="btn ghost">Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button></div>
    <div style="margin-top:12px"><table class="table" id="attendance_table"><thead><tr><th>Ø§Ù„Ù…Ø¹Ù„Ù…</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø­Ø¶ÙˆØ±</th><th>Ø§Ù„Ø§Ù†ØµØ±Ø§Ù</th><th>ØªØ£Ø®Ø±</th><th>Ø§Ù†ØµØ±Ø§Ù Ù…Ø¨ÙƒØ±</th><th>Ø®ØµÙ…</th><th>Ø­Ø°Ù</th></tr></thead><tbody></tbody></table></div>
  </section>

  <!-- Absences -->
  <section id="absences" class="card screen" style="display:none">
    <h3>Ø§Ù„ØºÙŠØ§Ø¨</h3>
    <label class="small">Ø§Ø®ØªØ± Ù…Ø¹Ù„Ù‘Ù…</label><select id="absence_teacher"></select>
    <div class="row" style="margin-top:8px">
      <div><label class="small">Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input id="abs_date" type="date"></div>
      <div><label class="small">Ø§Ù„Ù†ÙˆØ¹</label><select id="abs_type"><option value="excused">Ø¨Ø¹Ø°Ø±</option><option value="unexcused">Ø¨Ø¯ÙˆÙ† Ø¹Ø°Ø±</option></select></div>
      <div><label class="small" style="color:var(--danger)">Ù‚ÙŠÙ…Ø© Ø§Ù„Ø®ØµÙ…</label><input id="abs_penalty" type="number" min="0" step="0.5" value="0"></div>
    </div>
    <div style="margin-top:8px"><button id="saveAbsence" class="btn">Ø­ÙØ¸ Ø§Ù„ØºÙŠØ§Ø¨</button><button id="clearAbsence" class="btn ghost">Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button></div>
    <div style="margin-top:12px"><table class="table" id="absence_table"><thead><tr><th>Ø§Ù„Ù…Ø¹Ù„Ù…</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø®ØµÙ…</th><th>Ø­Ø°Ù</th></tr></thead><tbody></tbody></table></div>
  </section>

  <!-- Summary Report -->
  <section id="summaryReport" class="card screen" style="display:none">
    <h3>ğŸ“Š Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø®ØªØµØ±</h3>
    <div class="filter-box">
        <div class="small" style="margin-bottom:5px;font-weight:bold">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙØªØ±Ø© (Ø§ØªØ±ÙƒÙ‡Ø§ ÙØ§Ø±ØºØ© Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„):</div>
        <div class="filter-row">
            <div><label class="small">Ù…Ù† ØªØ§Ø±ÙŠØ®</label><input type="date" id="summary_start"></div>
            <div><label class="small">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label><input type="date" id="summary_end"></div>
            <div><button id="btnFilterSummary" class="btn" style="width:100%">Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button></div>
        </div>
    </div>
    <div class="small" id="reportDate" style="margin-bottom:10px;"></div>
    <table class="table"><thead id="summary_head"></thead><tbody id="summary_body"></tbody></table>
    <div id="bestTeacher" style="margin-top:10px;font-weight:bold;font-size:1.1rem;color:var(--emerald-dark);"></div>
    <div style="margin-top:12px;"><button id="exportExcel" class="btn">ğŸ“¥ ØªØµØ¯ÙŠØ± Excel</button></div>
  </section>

  <!-- Full report -->
  <section id="fullReport" class="card screen" style="display:none">
    <h3>Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ø§Ù…Ù„</h3>
    <div class="filter-box">
        <div class="small" style="margin-bottom:5px;font-weight:bold">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙØªØ±Ø©:</div>
        <div class="filter-row">
            <div><label class="small">Ù…Ù† ØªØ§Ø±ÙŠØ®</label><input type="date" id="full_start"></div>
            <div><label class="small">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label><input type="date" id="full_end"></div>
            <div><button id="btnFilterFull" class="btn" style="width:100%">Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button></div>
        </div>
    </div>
    <div style="margin-top:12px"><table class="table" id="full_table"><thead id="full_head"></thead><tbody id="full_body"></tbody><tfoot id="full_foot"></tfoot></table></div>
    <div style="margin-top:12px"><button id="printFull" class="btn ghost">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button></div>
  </section>

  <!-- Teacher Report -->
  <section id="teacherReport" class="card screen" style="display:none">
    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
        <div style="flex:1;min-width:200px"><label class="small">Ø§Ø®ØªØ± Ù…Ø¹Ù„Ù…Ø§Ù‹</label><select id="report_teacher_select"></select></div>
    </div>
    <div class="filter-box" style="margin-top:10px">
        <div class="filter-row">
            <div><label class="small">Ù…Ù† ØªØ§Ø±ÙŠØ®</label><input type="date" id="report_start"></div>
            <div><label class="small">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label><input type="date" id="report_end"></div>
            <div><button id="showReport" class="btn" style="width:100%">Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button></div>
        </div>
    </div>
    
    <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap;">
      <button id="printReport" class="btn ghost">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø­Ø§Ù„ÙŠ</button>
      <button id="printAllReports" class="btn" style="background:var(--emerald-dark)">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© ØªÙ‚Ø±ÙŠØ± Ù…Ø¬Ù…Ø¹ (Ù„Ù„ÙƒÙ„)</button>
      <button id="exportTeacherExcel" class="btn" style="background:#217346; color:#fff">ğŸ“¥ ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ± Excel</button>
      <button id="exportAllExcel" class="btn" style="background:#155724; color:#fff">ğŸ“¥ ØªØµØ¯ÙŠØ± Ø§Ù„ÙƒÙ„ (ÙˆØ±Ù‚Ø§Øª Ù…Ù†ÙØµÙ„Ø©)</button>
    </div>

    <div id="reportContainer" style="margin-top:18px;display:none">
      <div class="report-wrap" id="reportPrintArea">
        <div class="report-header">
          <div style="flex:1">
            <!-- Title Removed in Print -->
            <div class="report-title" id="r_teacher_name" style="font-size:1.8rem; font-weight:900; color:#000;"></div>
            <div id="r_teacher_meta" style="margin-top:8px;"></div> 
            <div class="muted small" id="r_period_info" style="margin-top:8px; font-weight:bold"></div>
          </div>
          <div class="kpi" id="r_kpis"></div>
        </div>
        <div class="section"><h4>Ø§Ù„Ù…Ù„Ø®Øµ</h4><div id="r_summary_text" class="muted"></div></div>
        <div class="section"><h4>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ø¯Ø§Ø¡</h4><div id="r_details_tables"></div></div>
        <div class="section"><h4>Ø§Ù„Ø­Ø¶ÙˆØ±/Ø§Ù„ØºÙŠØ§Ø¨</h4><div id="r_attendance_table"></div><div id="r_absence_table" style="margin-top:8px"></div></div>
        <div class="section"><h4>Ø§Ù„Ø³Ø¬Ù„Ø§Øª</h4><div id="r_sessions_list" class="muted"></div></div>
      </div>
    </div>
  </section>

  <!-- Settings -->
  <section id="settings" class="card screen" style="display:none">
    <h3>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</h3>
    <div class="row">
      <div><label class="small">Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¯ÙˆØ§Ù…</label><input type="time" id="official_start" value="07:00"></div>
      <div><label class="small">Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¯ÙˆØ§Ù…</label><input type="time" id="official_end" value="13:25"></div>
      <div><label class="small">Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø®ØµÙ… (ØªØ£Ø®Ø±)</label><input type="number" id="max_att" min="0" step="0.5" value="2"></div>
    </div>
    <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;">
      <button id="backup" class="btn">ğŸ’¾ Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ</button>
      <input type="file" id="restoreFile" accept=".json" style="display:none">
      <button id="restore" class="btn ghost">ğŸ“¤ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù†Ø³Ø®Ø©</button>
      <button id="resetAll" class="btn danger">ğŸ§¹ ØªØµÙÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…</button>
    </div>
  </section>

  <div class="toast" id="toast"></div>
</div>

<!-- Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
(function(){
const STORAGE = 'index27_final_v13_excel_sheet_names';
const ADMIN_USER = 'adminha';
const ADMIN_PASS = '123456ha';

let state = {
  teachers: [], criteria: [], evaluations: [], deductions: [], attendance: [], absences: [],
  official: {start:'07:00', end:'13:25', maxAttendancePenalty:2}
};
let uiState = { daily: null, weekly: null, monthly: null };

const DEFAULT_CRITERIA = [
  {id:'c_daily_1',name:'Ø§Ù„Ø·Ø§Ø¨ÙˆØ± Ø§Ù„ØµØ¨Ø§Ø­ÙŠ',kind:'daily',max:10,penalty:1, logic:'positive'},
  {id:'c_daily_2',name:'Ø§Ù„Ø¥Ù„ØªØ²Ø§Ù… Ø¨ØªÙˆÙ‚ÙŠØª Ø§Ù„Ø­ØµØµ',kind:'daily',max:10,penalty:1, logic:'negative'},
  {id:'c_daily_3',name:'Ø§Ù„Ø²ÙŠ Ø§Ù„Ø±Ø³Ù…ÙŠ',kind:'daily',max:10,penalty:0.5, logic:'negative'},
  {id:'c_week_1',name:'Ø§Ù„ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ',kind:'weekly',max:10,penalty:1, logic:'negative'},
  {id:'c_week_2',name:'Ø³Ø¬Ù„ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©',kind:'weekly',max:10,penalty:1, logic:'negative'},
  {id:'c_week_3',name:'Ù…Ù†Ø§ÙˆØ¨Ø© Ø§Ù„ÙØ³Ø­Ø©',kind:'weekly',max:10,penalty:1, logic:'negative'},
  {id:'c_week_4',name:'Ù…Ù†Ø§ÙˆØ¨Ø© Ø§Ù„ØµÙ„Ø§Ø©',kind:'weekly',max:10,penalty:1, logic:'negative'},
  {id:'c_month_1',name:'Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© ÙÙŠ Ø§Ù„Ø¥Ø°Ø§Ø¹Ø©',kind:'monthly',max:10,penalty:1, logic:'negative'}
];

function save(){ try{ localStorage.setItem(STORAGE, JSON.stringify(state)); }catch(e){} }
function load(){
  const raw = localStorage.getItem(STORAGE);
  if(raw){ try{ state = JSON.parse(raw); } catch(e){ state.criteria = DEFAULT_CRITERIA.slice(); } }
  if(!Array.isArray(state.criteria) || state.criteria.length===0) state.criteria = DEFAULT_CRITERIA.slice();
  if(!Array.isArray(state.teachers)) state.teachers = [];
  if(!Array.isArray(state.deductions)) state.deductions = [];
  save();
}
function uid(p='id'){ return p + '_' + Date.now().toString(36) + Math.random().toString(36).slice(2,6); }
function el(q){ return document.querySelector(q); }
function els(q){ return Array.from(document.querySelectorAll(q)); }
function toast(msg){ const t=el('#toast'); if(!t) return; t.textContent = msg; t.style.display = 'block'; setTimeout(()=> t.style.display='none',2200); }
function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function minutesBetween(t1,t2){ if(!t1||!t2) return 0; const a=t1.split(':').map(Number); const b=t2.split(':').map(Number); return (b[0]*60+b[1]) - (a[0]*60+a[1]); }
function isDateInRange(dateStr, start, end) {
    if(!dateStr) return false;
    const d = new Date(dateStr); d.setHours(0,0,0,0);
    const s = start ? new Date(start) : null; if(s) s.setHours(0,0,0,0);
    const e = end ? new Date(end) : null; if(e) e.setHours(0,0,0,0);
    if(s && d < s) return false;
    if(e && d > e) return false;
    return true;
}

window.app = {
  deleteTeacher: (id) => { if(!confirm('Ø­Ø°Ù Ø§Ù„Ù…Ø¹Ù„Ù…ØŸ')) return; state.teachers = state.teachers.filter(t=> t.id!==id); state.deductions = state.deductions.filter(d=> d.teacherId !== id); save(); renderTeachers(); toast('ØªÙ… Ø§Ù„Ø­Ø°Ù'); },
  deleteCriteria: (id) => { if(!confirm('Ø­Ø°Ù Ø§Ù„Ø¨Ù†Ø¯ØŸ')) return; state.criteria = state.criteria.filter(x=> x.id !== id); state.deductions = state.deductions.filter(d=> d.criteriaId !== id); save(); renderCriteria(); toast('ØªÙ… Ø§Ù„Ø­Ø°Ù'); },
  deleteTeacherFromSession: (sessionId, teacherId, kind) => { if(!confirm('Ø­Ø°Ù Ø³Ø¬Ù„ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¹Ù„Ù…ØŸ')) return; const sess = state.evaluations.find(s => s.id === sessionId); if(!sess) return; const deductionsToRemove = state.deductions.filter(d => d.teacherId === teacherId && sess.deductionIds.includes(d.id)); const idsToRemove = deductionsToRemove.map(d => d.id); state.deductions = state.deductions.filter(d => !idsToRemove.includes(d.id)); sess.deductionIds = sess.deductionIds.filter(id => !idsToRemove.includes(id)); if(sess.deductionIds.length === 0) { state.evaluations = state.evaluations.filter(s => s.id !== sessionId); } save(); renderSessions(kind); toast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„'); },
  deleteAttendance: (id) => { if(!confirm('Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ØŸ')) return; state.attendance = state.attendance.filter(x=>x.id!==id); save(); renderAttendanceTable(); toast('ØªÙ… Ø§Ù„Ø­Ø°Ù'); },
  deleteAbsence: (id) => { if(!confirm('Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ØŸ')) return; state.absences = state.absences.filter(x=>x.id!==id); save(); renderAbsences(); toast('ØªÙ… Ø§Ù„Ø­Ø°Ù'); }
};

function renderTeachers(){
  const tbody = el('#teachersTable tbody'); if(!tbody) return; tbody.innerHTML='';
  state.teachers.forEach(t=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(t.name)}</td><td>${escapeHtml(t.id)}</td><td>${escapeHtml(t.subject||'')}</td><td>${escapeHtml(t.email||'')}</td>
      <td><button class="btn ghost editTeacher" data-id="${t.id}">ØªØ¹Ø¯ÙŠÙ„</button> <button class="btn" style="background:var(--danger);color:#fff" onclick="app.deleteTeacher('${t.id}')">Ø­Ø°Ù</button></td>`;
    tbody.appendChild(tr);
  });
  els('.editTeacher').forEach(b=> b.addEventListener('click', e=> startEditTeacher(e.currentTarget.dataset.id)));
}

function renderCriteria(){
  const tbody = el('#ci_table tbody'); if(!tbody) return; tbody.innerHTML='';
  (state.criteria||[]).forEach(c=>{
    const tr = document.createElement('tr');
    let logicText = (c.logic === 'positive') ? '<span style="color:var(--emerald)">âœ” Ø±ØµØ¯ Ø­Ø¶ÙˆØ±</span>' : '<span style="color:var(--danger)">âœ– Ø±ØµØ¯ Ù…Ø®Ø§Ù„ÙØ©</span>';
    tr.innerHTML = `<td>${escapeHtml(c.name)}</td><td class="center">${c.max}</td><td>${escapeHtml(c.kind)}</td><td class="center">${logicText}</td><td class="center">${c.penalty}</td>
      <td><button class="btn ghost editCi" data-id="${c.id}">ØªØ¹Ø¯ÙŠÙ„</button> <button class="btn" style="background:var(--danger);color:#fff" onclick="app.deleteCriteria('${c.id}')">Ø­Ø°Ù</button></td>`;
    tbody.appendChild(tr);
  });
  els('.editCi').forEach(b=> b.addEventListener('click', e=> startEditCi(e.currentTarget.dataset.id)));
}

function renderAttendanceTable(){
  const tbody = el('#attendance_table tbody'); if(!tbody) return; tbody.innerHTML='';
  state.attendance.forEach(a=>{
    const t = state.teachers.find(tt=> tt.id===a.teacherId) || {name:'?'};
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(t.name)}</td><td>${a.date}</td><td class="center">${a.arrival}</td><td class="center">${a.leave}</td><td class="center">${a.late}</td><td class="center">${a.early}</td><td class="center">${a.deduction}</td>
      <td class="center"><button class="btn ghost" onclick="app.deleteAttendance('${a.id}')">Ø­Ø°Ù</button></td>`;
    tbody.appendChild(tr);
  });
}

function renderAbsences(){
  const tbody = el('#absence_table tbody'); if(!tbody) return; tbody.innerHTML='';
  state.absences.forEach(a=>{
    const t = state.teachers.find(tt=> tt.id===a.teacherId) || {name:'?'};
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(t.name)}</td><td>${a.date}</td><td>${a.type==='excused'?'Ø¨Ø¹Ø°Ø±':'Ø¨Ø¯ÙˆÙ† Ø¹Ø°Ø±'}</td><td class="center">${a.penalty}</td>
      <td class="center"><button class="btn ghost" onclick="app.deleteAbsence('${a.id}')">Ø­Ø°Ù</button></td>`;
    tbody.appendChild(tr);
  });
}

function renderSessions(kind){
  const headEl = el('#'+kind+'_head'); const bodyEl = el('#'+kind+'_body'); if(!headEl || !bodyEl) return;
  headEl.innerHTML = '<tr><th>Ø§Ù„Ù…Ø¹Ù„Ù…</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø¨Ù†Ø¯</th><th>Ø®ØµÙ…</th><th>Ø­Ø°Ù</th></tr>'; bodyEl.innerHTML = '';
  const rows = state.evaluations.filter(s=> s.kind===kind).sort((a,b)=> new Date(b.date) - new Date(a.date));
  rows.forEach(sess=>{
    if((sess.deductionIds||[]).length === 0) return;
    const tIds = [...new Set((sess.deductionIds||[]).map(id=> { const d=state.deductions.find(x=>x.id===id); return d?d.teacherId:null; }).filter(Boolean))];
    tIds.forEach(tid=>{
      const t = state.teachers.find(x=> x.id===tid) || {name:'?'};
      const deds = state.deductions.filter(d=> d.teacherId===tid && (sess.deductionIds||[]).includes(d.id));
      const critNames = deds.map(d=> { const c=state.criteria.find(cc=>cc.id===d.criteriaId); return c?c.name:'?'; }).join(', ');
      const total = deds.reduce((s,d)=> s + (d.deduction||0), 0);
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${escapeHtml(t.name)}</td><td>${new Date(sess.date).toLocaleDateString('ar-EG')}</td><td>${critNames}</td><td class="center" style="color:var(--danger)">${total}</td>
        <td class="center"><button class="btn" style="background:var(--danger);color:#fff" onclick="app.deleteTeacherFromSession('${sess.id}','${tid}','${kind}')">Ø­Ø°Ù</button></td>`;
      bodyEl.appendChild(tr);
    });
  });
}

function addTeacher(){
  const name = el('#t_name').value.trim(); const id = el('#t_id').value.trim(); 
  const subject = el('#t_subject').value.trim(); const email = el('#t_email').value.trim();
  if(!name||!id){ alert('Ø§Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª'); return; }
  if(state.teachers.some(t=>t.id===id)){ alert('Ø§Ù„Ø±Ù‚Ù… Ù…ÙˆØ¬ÙˆØ¯'); return; }
  state.teachers.push({id,name,subject,email}); save(); renderTeachers(); populateSelects(); 
  el('#t_name').value=''; el('#t_id').value=''; el('#t_subject').value=''; el('#t_email').value='';
  toast('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ù„Ù…');
}
function startEditTeacher(id){
  const t = state.teachers.find(x=> x.id===id); if(!t) return;
  el('#t_name').value = t.name; el('#t_id').value = t.id; el('#t_subject').value = t.subject||''; el('#t_email').value = t.email||'';
  const btn = el('#addTeacher'); btn.textContent='Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„'; btn.onclick = ()=> saveEditTeacher(id);
}
function saveEditTeacher(id){
  const t = state.teachers.find(x=> x.id===id); if(!t) return;
  t.name = el('#t_name').value.trim(); t.subject = el('#t_subject').value.trim(); t.email = el('#t_email').value.trim();
  save(); renderTeachers(); populateSelects(); el('#addTeacher').textContent='Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„Ù‘Ù…'; el('#addTeacher').onclick = addTeacher;
  el('#t_name').value=''; el('#t_id').value=''; el('#t_subject').value=''; el('#t_email').value='';
  toast('ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„');
}
function addCriterion(){
  const name = el('#ci_name').value.trim(); const kind = el('#ci_kind').value; let max = Number(el('#ci_max').value)||10; let penalty = Number(el('#ci_penalty').value)||1; const logic = el('#ci_logic').value; if(!name) return;
  state.criteria.push({id:uid('ci'),name,kind,max,penalty,logic}); save(); renderCriteria(); toast('ØªÙ… Ø§Ù„Ø¥Ø¶Ø§ÙØ©');
}
function startEditCi(id){
  const c = state.criteria.find(x=> x.id===id); if(!c) return;
  el('#ci_name').value = c.name; el('#ci_max').value = c.max; el('#ci_kind').value = c.kind; el('#ci_penalty').value = c.penalty; el('#ci_logic').value = c.logic || 'negative';
  el('#addCi').textContent='Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„'; el('#addCi').onclick = ()=> saveEditCi(id);
}
function saveEditCi(id){
  const c = state.criteria.find(x=> x.id===id); if(!c) return;
  c.name = el('#ci_name').value.trim(); c.max = Number(el('#ci_max').value)||10; c.kind = el('#ci_kind').value; c.penalty = Number(el('#ci_penalty').value)||0; c.logic = el('#ci_logic').value;
  save(); el('#addCi').textContent='â• Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯ Ø¬Ø¯ÙŠØ¯'; el('#addCi').onclick = addCriterion; el('#ci_name').value=''; renderCriteria(); toast('ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„');
}
function restoreDefaults(){ if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) return; state.criteria = DEFAULT_CRITERIA.slice(); save(); renderCriteria(); toast('ØªÙ…Øª Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©'); }

function buildGridForKind(kind){
  const wrap = el('#'+kind+'_table_wrap'); if(!wrap) return; wrap.innerHTML = '';
  const crits = (state.criteria||[]).filter(c=> c.kind===kind); const teachers = state.teachers || [];
  if(crits.length===0){ wrap.innerHTML = '<div class="small">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ù†ÙˆØ¯ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù†ÙˆØ¹</div>'; return; }
  if(!uiState[kind] || !crits.find(c=> c.id === uiState[kind])) { uiState[kind] = crits[0].id; }
  const activeCrit = crits.find(c => c.id === uiState[kind]); const isPos = (activeCrit.logic === 'positive');
  const selectContainer = document.createElement('div'); selectContainer.className="filter-box"; selectContainer.style.display="flex"; selectContainer.style.alignItems="center"; selectContainer.style.gap="10px";
  const label = document.createElement('label'); label.innerHTML = "<strong>Ø§Ø®ØªØ± Ø¨Ù†Ø¯ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…:</strong>";
  const select = document.createElement('select'); select.style.cssText = "padding:8px; border-radius:6px; flex:1";
  crits.forEach(c => { const option = document.createElement('option'); option.value = c.id; const logicSign = c.logic==='positive' ? 'âœ”' : 'âœ–'; option.textContent = `${logicSign} ${c.name} (Ø®ØµÙ…: ${c.penalty})`; if(c.id === activeCrit.id) option.selected = true; select.appendChild(option); });
  select.addEventListener('change', (e) => { uiState[kind] = e.target.value; buildGridForKind(kind); });
  selectContainer.appendChild(label); selectContainer.appendChild(select); wrap.appendChild(selectContainer);
  const tbl = document.createElement('table'); tbl.className = 'table';
  const thr = document.createElement('tr'); const actionText = isPos ? 'Ø§Ù„Ø­Ø§Ù„Ø© (Ø­Ø¯Ø¯ Ù„Ù„Ø­Ø¶ÙˆØ± âœ”)' : 'Ø§Ù„Ø­Ø§Ù„Ø© (Ø­Ø¯Ø¯ Ù„Ù„Ù…Ø®Ø§Ù„ÙØ© âœ–)'; const color = isPos ? 'var(--emerald)' : 'var(--danger)';
  thr.innerHTML = `<th style="width:40%">Ø§Ù„Ù…Ø¹Ù„Ù…</th><th>${escapeHtml(activeCrit.name)} <span class="small" style="color:${color}">${actionText}</span></th><th style="width:15%">Ø§Ù„Ø®ØµÙ… Ø§Ù„Ù…ØªÙˆÙ‚Ø¹</th>`;
  tbl.appendChild(thr);
  teachers.forEach(t=>{
    const tr = document.createElement('tr'); const chkId = `chk_${kind}_${activeCrit.id}_${t.id}`; const chkClass = isPos ? 'chk-positive' : ''; const chkLabel = isPos ? 'Ø­Ø§Ø¶Ø± / Ù…Ù„ØªØ²Ù…' : 'Ù…Ø®Ø§Ù„Ù / Ù…Ù‚ØµØ±';
    tr.innerHTML = `<td><strong>${escapeHtml(t.name)}</strong></td><td class="center" style="background:#fff;"><label style="cursor:pointer; display:block; padding:5px;"><input type="checkbox" class="${chkClass}" id="${chkId}" data-criteria="${activeCrit.id}" data-teacher="${t.id}" style="transform:scale(1.2);"><span style="margin-right:8px; font-size:0.9rem; color:#777">${chkLabel}</span></label></td><td class="center sum-cell" data-teacher="${t.id}" style="font-weight:bold; color:var(--danger)">0</td>`;
    tbl.appendChild(tr);
  });
  wrap.appendChild(tbl);
  wrap.querySelectorAll('input[type="checkbox"]').forEach(chk=>{ chk.addEventListener('change', ()=> updateGridSums(kind)); });
  updateGridSums(kind);
}
function updateGridSums(kind){
  const currentCritId = uiState[kind]; if(!currentCritId) return;
  const crits = (state.criteria||[]).filter(c=> c.id === currentCritId); const activeCrit = crits[0];
  const tbody = el('#'+kind+'_table_wrap table'); if(!tbody) return;
  Array.from(tbody.querySelectorAll('tr')).forEach((row, idx)=>{
    if(idx===0) return; // skip header
    const teacherId = row.querySelector('.sum-cell').dataset.teacher; let total = 0; const chk = row.querySelector(`input[data-criteria="${activeCrit.id}"][data-teacher="${teacherId}"]`);
    if(chk){ const isPos = (activeCrit.logic === 'positive'); if(isPos && !chk.checked) total = Number(activeCrit.penalty||0); if(!isPos && chk.checked) total = Number(activeCrit.penalty||0); }
    const cell = row.querySelector('.sum-cell'); cell.textContent = total; cell.style.color = total>0 ? 'var(--danger)' : '#ccc';
  });
}
function saveGridSession(kind){
  const dateInput = el('#'+kind+'_date'); const dateVal = dateInput ? dateInput.value : ''; if(!dateVal){ alert('Ø§Ø®ØªØ± ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¬Ù„Ø³Ø©'); return; }
  const currentCritId = uiState[kind]; if(!currentCritId) return;
  const activeCrit = (state.criteria||[]).find(c=> c.id === currentCritId);
  const rows = Array.from(el('#'+kind+'_table_wrap table').querySelectorAll('tr')).slice(1);
  const createdDedIds = [];
  rows.forEach(row=>{
    const teacherId = row.querySelector('.sum-cell').dataset.teacher; const chk = row.querySelector(`input`);
    if(chk){ const isPos = (activeCrit.logic === 'positive'); let deductAmount = 0; if(isPos && !chk.checked) deductAmount = Number(activeCrit.penalty||0); if(!isPos && chk.checked) deductAmount = Number(activeCrit.penalty||0); if(deductAmount > 0){ const ded = { id: uid('ded'), teacherId, criteriaId: activeCrit.id, kind, date: new Date(dateVal).toISOString(), deduction: deductAmount, note: '' }; state.deductions.push(ded); createdDedIds.push(ded.id); } }
  });
  state.evaluations.push({ id: uid('sess'), kind, date: new Date(dateVal).toISOString(), deductionIds: createdDedIds });
  save(); renderSessions(kind); rows.forEach(r=> { const c=r.querySelector('input'); if(c) c.checked=false; }); updateGridSums(kind); toast('ØªÙ… Ø§Ù„Ø­ÙØ¸');
}

function saveAttendance(){
  const sel = el('#attendance_teacher'); if(!sel.value) return alert('Ø§Ø®ØªØ± Ù…Ø¹Ù„Ù…Ø§Ù‹');
  const date = el('#att_date').value; if(!date) return alert('Ø§Ø®ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ®');
  const arrival = el('#att_arrival').value; const leave = el('#att_leave').value;
  const late = Math.max(0, minutesBetween(el('#official_start').value, arrival));
  const early = Math.max(0, minutesBetween(leave, el('#official_end').value));
  const total = late + early; let ded = Math.floor(total/30) * 0.5; const cap = Number(el('#max_att').value); if(ded>cap) ded=cap;
  const rec = {id: uid('att'), teacherId: sel.value, date, arrival, leave, late, early, deduction: ded};
  state.attendance.push(rec); if(ded>0) state.deductions.push({ id: uid('ded'), teacherId: sel.value, criteriaId: 'att_auto', kind: 'attendance', date: new Date().toISOString(), deduction: ded });
  save(); renderAttendanceTable(); toast('ØªÙ… Ø§Ù„Ø­ÙØ¸');
}

function bindAbsenceLogic(){
  const sel = el('#abs_type'); const inp = el('#abs_penalty'); if(!sel || !inp) return;
  sel.addEventListener('change', ()=>{
    if(sel.value === 'excused'){ inp.value = 0; inp.disabled = true; inp.style.background = '#eee'; } 
    else { inp.disabled = false; inp.style.background = '#fff'; }
  });
  // Trigger once
  if(sel.value === 'excused'){ inp.value = 0; inp.disabled = true; inp.style.background = '#eee'; }
}
function saveAbsence(){
  const sel = el('#absence_teacher'); if(!sel.value) return alert('Ø§Ø®ØªØ± Ù…Ø¹Ù„Ù…Ø§Ù‹');
  const date = el('#abs_date').value; if(!date) return alert('Ø§Ø®ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ®');
  const type = el('#abs_type').value; let penalty = 0;
  if(type === 'unexcused'){ penalty = Number(el('#abs_penalty').value) || 0; }
  state.absences.push({ id: uid('abs'), teacherId: sel.value, date, type, penalty });
  if(penalty > 0){ state.deductions.push({ id: uid('ded'), teacherId: sel.value, criteriaId: 'abs_auto', kind: 'absence', date: new Date().toISOString(), deduction: penalty }); }
  save(); renderAbsences(); toast('ØªÙ… Ø§Ù„Ø­ÙØ¸');
}

function renderSummaryReport(){
  const head = el('#summary_head'); const body = el('#summary_body'); if(!head) return;
  const s = el('#summary_start').value; const e = el('#summary_end').value;
  el('#reportDate').textContent = 'ØªØ§Ø±ÙŠØ®: ' + new Date().toLocaleDateString();
  head.innerHTML = ''; body.innerHTML = '';
  const crits = state.criteria;
  let h = '<tr><th>Ø§Ù„Ù…Ø¹Ù„Ù…</th><th>Ø§Ù„ØªØ®ØµØµ</th>'; crits.forEach(c=> h += `<th>${escapeHtml(c.name)}</th>`); h += `<th>Ø§Ù„Ø­Ø¶ÙˆØ±</th><th>Ø§Ù„ØºÙŠØ§Ø¨</th><th>Ø§Ù„Ù†Ø§ØªØ¬</th><th>%</th></tr>`; head.innerHTML = h;
  const rows = state.teachers.map(t=>{
    let max = 0; let cur = 0;
    const cells = crits.map(c=>{
      max += c.max;
      const deds = state.deductions.filter(d=> d.teacherId===t.id && d.criteriaId===c.id && isDateInRange(d.date,s,e));
      const sum = deds.reduce((a,b)=>a+b.deduction,0);
      const final = Math.max(0, c.max - sum); cur += final;
      return `<td class="center">${final} <span class="small">(-${sum})</span></td>`;
    });
    const att = state.deductions.filter(d=> d.teacherId===t.id && d.kind==='attendance' && isDateInRange(d.date,s,e)).reduce((a,b)=>a+b.deduction,0);
    const abs = state.deductions.filter(d=> d.teacherId===t.id && d.kind==='absence' && isDateInRange(d.date,s,e)).reduce((a,b)=>a+b.deduction,0);
    const final = Math.max(0, cur - (att+abs));
    const pct = max ? ((final/max)*100).toFixed(1) : 0;
    return { t, html: cells.join(''), att, abs, final, pct };
  });
  rows.sort((a,b)=> b.final - a.final).forEach((r,i)=>{
    body.innerHTML += `<tr style="background:${i<3?'#fff6cc':''}"><td>${escapeHtml(r.t.name)}</td><td>${escapeHtml(r.t.subject||'-')}</td>${r.html}<td class="center">${r.att}</td><td class="center">${r.abs}</td><td class="center" style="font-weight:bold">${r.final}</td><td class="center">${r.pct}%</td></tr>`;
  });
}

function renderFullReport(){
  const head = el('#full_head'); const body = el('#full_body');
  const s = el('#full_start').value; const e = el('#full_end').value;
  let h = '<tr><th>Ø§Ù„Ù…Ø¹Ù„Ù…</th>'; state.criteria.forEach(c=> h+=`<th>${c.name}</th>`); h += '<th>Ø§Ù„Ù†Ø§ØªØ¬</th></tr>'; head.innerHTML=h; body.innerHTML='';
  state.teachers.forEach(t=>{
     let row = `<tr><td>${escapeHtml(t.name)}</td>`; let tot = 0;
     state.criteria.forEach(c=>{
        const ded = state.deductions.filter(d=> d.teacherId===t.id && d.criteriaId===c.id && isDateInRange(d.date,s,e)).reduce((a,b)=>a+b.deduction,0);
        const val = Math.max(0, c.max - ded); tot += val; row += `<td class="center">${val}</td>`;
     });
     const other = state.deductions.filter(d=> d.teacherId===t.id && (d.kind==='attendance'||d.kind==='absence') && isDateInRange(d.date,s,e)).reduce((a,b)=>a+b.deduction,0);
     row += `<td class="center"><strong>${Math.max(0, tot - other)}</strong></td></tr>`; body.innerHTML += row;
  });
}

function generateTeacherHtmlString(teacher, start, end){
  let max=0, ded=0;
  let details = '';
  const tid = teacher.id;
  
  state.criteria.forEach(c=>{
    max += c.max;
    const d = state.deductions.filter(x=>x.teacherId===tid && x.criteriaId===c.id && isDateInRange(x.date,start,end)).reduce((a,b)=>a+b.deduction,0);
    ded += d; 
    details += `<div style="display:flex;justify-content:space-between;border-bottom:1px solid #eee;padding:8px 0;"><span>${c.name}</span><span>${Math.max(0, c.max-d)} / ${c.max}</span></div>`;
  });
  
  const abs = state.deductions.filter(x=>x.teacherId===tid && (x.kind==='attendance'||x.kind==='absence') && isDateInRange(x.date,start,end)).reduce((a,b)=>a+b.deduction,0);
  const final = Math.max(0, max - ded - abs); 
  const pct = max ? ((final/max)*100).toFixed(1) : 0;
  
  const attList = state.attendance.filter(a=>a.teacherId===tid && isDateInRange(a.date,start,end)).map(a=>`<div>${a.date}: ${a.arrival}-${a.leave} (-${a.deduction})</div>`).join('') || '-';
  const absList = state.absences.filter(a=>a.teacherId===tid && isDateInRange(a.date,start,end)).map(a=>`<div>${a.date}: ${a.type} (-${a.penalty})</div>`).join('') || '-';

  return `
    <div class="report-page" style="page-break-after:always; margin-bottom:30px; border-bottom:2px dashed #ccc; padding-bottom:20px;">
      <div class="report-header">
        <div>
          <!-- Title Removed in Print -->
          <div class="report-title" style="font-size:1.8rem;font-weight:bold">${escapeHtml(teacher.name)}</div>
          <div class="muted" style="font-size:1.1rem; margin:4px 0;">
            ğŸ†” ${escapeHtml(teacher.id)} | ğŸ“š ${escapeHtml(teacher.subject||'')}
            ${teacher.email ? `<br><span style="color:#198754;font-size:0.95rem;">ğŸ“§ ${escapeHtml(teacher.email)}</span>` : '<br><span style="color:#999;font-size:0.85rem;">(Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ)</span>'}
          </div>
          <div class="muted small" style="margin-top:5px; font-weight:bold">${(start||end) ? ('Ù…Ù† '+start+' Ø¥Ù„Ù‰ '+end) : 'ÙƒÙ„ Ø§Ù„ÙØªØ±Ø§Øª'}</div>
        </div>
        <div class="kpi" style="display:flex;gap:15px">
           <div class="card-kpi"><div>${final}</div><small>Ø§Ù„Ø¯Ø±Ø¬Ø©</small></div>
           <div class="card-kpi"><div>${pct}%</div><small>Ø§Ù„Ù†Ø³Ø¨Ø©</small></div>
           <div class="card-kpi"><div>${abs}</div><small>Ø®ØµÙ… ØºÙŠØ§Ø¨</small></div>
        </div>
      </div>
      <div class="section"><h4>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ø¯Ø§Ø¡</h4>${details}</div>
      <div class="section"><h4>Ø§Ù„Ø­Ø¶ÙˆØ±</h4>${attList}</div>
      <div class="section"><h4>Ø§Ù„ØºÙŠØ§Ø¨</h4>${absList}</div>
    </div>
  `;
}

function renderTeacherReport(tid){
  const t = state.teachers.find(x=>x.id===tid); if(!t) return;
  const s = el('#report_start').value; const e = el('#report_end').value;
  
  // LIVE VIEW
  el('#r_teacher_name').textContent = t.name; 
  let metaHtml = `<div>ğŸ†” ${escapeHtml(t.id)} | ğŸ“š ${escapeHtml(t.subject||'ØºÙŠØ± Ù…Ø­Ø¯Ø¯')}</div>`;
  if(t.email){
      metaHtml += `<div style="margin-top:6px; color:#198754; font-weight:bold; font-size:1rem;">ğŸ“§ ${escapeHtml(t.email)}</div>`;
  } else {
      metaHtml += `<div style="margin-top:6px; color:#999; font-size:0.85rem;">(Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³Ø¬Ù„)</div>`;
  }
  el('#r_teacher_meta').innerHTML = metaHtml;
  el('#r_period_info').textContent = (s||e) ? `Ù…Ù† ${s} Ø¥Ù„Ù‰ ${e}` : 'ÙƒÙ„ Ø§Ù„ÙØªØ±Ø§Øª';
  
  let max=0, ded=0; let details = '';
  state.criteria.forEach(c=>{
    max += c.max;
    const d = state.deductions.filter(x=>x.teacherId===tid && x.criteriaId===c.id && isDateInRange(x.date,s,e)).reduce((a,b)=>a+b.deduction,0);
    ded += d; details += `<div style="display:flex;justify-content:space-between;border-bottom:1px solid #eee;padding:5px;"><span>${c.name}</span><span>${Math.max(0, c.max-d)} / ${c.max}</span></div>`;
  });
  const abs = state.deductions.filter(x=>x.teacherId===tid && (x.kind==='attendance'||x.kind==='absence') && isDateInRange(x.date,s,e)).reduce((a,b)=>a+b.deduction,0);
  const final = Math.max(0, max - ded - abs); const pct = max ? ((final/max)*100).toFixed(1) : 0;
  
  el('#r_kpis').innerHTML = `<div class="card-kpi"><div>${final}</div><small>Ø§Ù„Ø¯Ø±Ø¬Ø©</small></div><div class="card-kpi"><div>${pct}%</div><small>Ø§Ù„Ù†Ø³Ø¨Ø©</small></div><div class="card-kpi"><div>${abs}</div><small>Ø®ØµÙ… ØºÙŠØ§Ø¨/ØªØ£Ø®Ø±</small></div>`;
  el('#r_details_tables').innerHTML = details;
  
  const attList = state.attendance.filter(a=>a.teacherId===tid && isDateInRange(a.date,s,e)).map(a=>`<div>${a.date}: ${a.arrival}-${a.leave} (-${a.deduction})</div>`).join('');
  el('#r_attendance_table').innerHTML = attList || '-';
  const absList = state.absences.filter(a=>a.teacherId===tid && isDateInRange(a.date,s,e)).map(a=>`<div>${a.date}: ${a.type} (-${a.penalty})</div>`).join('');
  el('#r_absence_table').innerHTML = absList || '-';
  
  el('#reportContainer').style.display='block';
}

function printAllTeachers(){
  const s = el('#report_start').value; const e = el('#report_end').value;
  let fullHtml = '';
  state.teachers.forEach(t => {
      fullHtml += generateTeacherHtmlString(t, s, e);
  });
  
  const win = window.open('', '_blank');
  win.document.write(`<html><head><title>ØªÙ‚Ø±ÙŠØ± Ù…Ø¬Ù…Ø¹</title><style>
    body{font-family:'Cairo',sans-serif; direction:rtl; padding:20px;}
    .report-header{display:flex;justify-content:space-between;border-bottom:3px solid #198754;padding-bottom:15px;margin-bottom:20px;align-items:flex-end;}
    .kpi{display:flex;gap:15px;}
    .card-kpi{background:#f4f9f6;padding:10px;border-radius:8px;text-align:center;border:1px solid #ccc;min-width:100px;}
    .section h4{border-right:4px solid #198754;padding-right:10px;margin:15px 0 10px 0;font-size:1.1rem;}
    @media print { .report-page { page-break-after: always; } }
  </style></head><body>${fullHtml}</body></html>`);
  win.document.close();
  setTimeout(()=> { win.focus(); win.print(); }, 500);
}

function exportSingleTeacherToExcel(){
  const tid = el('#report_teacher_select').value;
  if(!tid) return alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø¹Ù„Ù… Ø£ÙˆÙ„Ø§Ù‹');
  const t = state.teachers.find(x=>x.id===tid);
  const s = el('#report_start').value;
  const e = el('#report_end').value;
  generateAndSaveExcel(t, s, e);
}

function exportAllTeachersToExcel(){
  const s = el('#report_start').value;
  const e = el('#report_end').value;
  
  // Create a new workbook
  const wb = XLSX.utils.book_new();
  
  state.teachers.forEach((t) => {
      // Get data for this specific teacher
      const teacherData = getTeacherExcelRows(t, s, e);
      // Create a sheet
      const ws = XLSX.utils.aoa_to_sheet(teacherData);
      
      // Sanitize sheet name
      // Excel sheet names cannot contain: [ ] * / \ ? and max 31 chars
      let sheetName = t.name.replace(/[\[\]\*\/\\\?]/g, '').substring(0, 30) || "Teacher";
      
      // Handle duplicate names
      let counter = 1;
      let originalName = sheetName;
      while(wb.Sheets[sheetName]) {
          sheetName = (originalName + "_" + counter).substring(0,30);
          counter++;
      }

      // Append sheet to workbook
      XLSX.utils.book_append_sheet(wb, ws, sheetName);
  });

  if(wb.SheetNames.length === 0) return alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¹Ù„Ù…ÙŠÙ†");

  // Save file
  XLSX.writeFile(wb, `ØªÙ‚Ø±ÙŠØ±_Ø¬Ù…ÙŠØ¹_Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†_Ù…ÙØµÙ„.xlsx`);
}

// Helper: Calculate data for one teacher and return array of arrays (rows)
function getTeacherExcelRows(t, s, e) {
  let max=0, ded=0;
  const detRows = [];
  state.criteria.forEach(c=>{
    max += c.max;
    const d = state.deductions.filter(x=>x.teacherId===t.id && x.criteriaId===c.id && isDateInRange(x.date,s,e)).reduce((a,b)=>a+b.deduction,0);
    ded += d;
    detRows.push([c.name, c.max, d, Math.max(0, c.max-d)]);
  });
  
  const absDed = state.deductions.filter(x=>x.teacherId===t.id && (x.kind==='attendance'||x.kind==='absence') && isDateInRange(x.date,s,e)).reduce((a,b)=>a+b.deduction,0);
  const final = Math.max(0, max - ded - absDed);
  const pct = max ? ((final/max)*100).toFixed(1) : 0;

  const data = [];
  data.push(["ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ù…ÙØµÙ„"]);
  data.push(["Ø§Ù„Ø§Ø³Ù…", t.name]);
  data.push(["Ø§Ù„Ø±Ù‚Ù…", t.id]);
  data.push(["Ø§Ù„Ù…Ø§Ø¯Ø©", t.subject]);
  data.push(["Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„", t.email]);
  data.push(["Ø§Ù„ÙØªØ±Ø©", (s||e) ? `Ù…Ù† ${s} Ø¥Ù„Ù‰ ${e}` : 'ÙƒÙ„ Ø§Ù„ÙØªØ±Ø§Øª']);
  data.push([]); 

  data.push(["Ø§Ù„Ø®Ù„Ø§ØµØ©"]);
  data.push(["Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©", "Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ© %", "Ø®ØµÙ… Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨"]);
  data.push([final, pct + "%", absDed]);
  data.push([]);

  data.push(["ØªÙØ§ØµÙŠÙ„ Ø¨Ù†ÙˆØ¯ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…"]);
  data.push(["Ø§Ù„Ø¨Ù†Ø¯", "Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰", "Ø§Ù„Ø®ØµÙ… Ø§Ù„Ù…Ø±ØµÙˆØ¯", "Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø©"]);
  detRows.forEach(r => data.push(r));
  data.push([]);

  data.push(["Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø§Ù†ØµØ±Ø§Ù"]);
  data.push(["Ø§Ù„ØªØ§Ø±ÙŠØ®", "ÙˆÙ‚Øª Ø§Ù„Ø­Ø¶ÙˆØ±", "ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØµØ±Ø§Ù", "Ø§Ù„Ø®ØµÙ…"]);
  const atts = state.attendance.filter(a=>a.teacherId===t.id && isDateInRange(a.date,s,e));
  if(atts.length){
      atts.forEach(a => data.push([a.date, a.arrival, a.leave, a.deduction]));
  } else {
      data.push(["Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª"]);
  }
  data.push([]);

  data.push(["Ø³Ø¬Ù„ Ø§Ù„ØºÙŠØ§Ø¨"]);
  data.push(["Ø§Ù„ØªØ§Ø±ÙŠØ®", "Ø§Ù„Ù†ÙˆØ¹", "Ø§Ù„Ø®ØµÙ…"]);
  const abss = state.absences.filter(a=>a.teacherId===t.id && isDateInRange(a.date,s,e));
  if(abss.length){
      abss.forEach(a => data.push([a.date, (a.type==='excused'?'Ø¨Ø¹Ø°Ø±':'Ø¨Ø¯ÙˆÙ† Ø¹Ø°Ø±'), a.penalty]));
  } else {
      data.push(["Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØºÙŠØ§Ø¨"]);
  }
  
  return data;
}

function generateAndSaveExcel(t, s, e) {
    const data = getTeacherExcelRows(t, s, e);
    const ws = XLSX.utils.aoa_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Ø§Ù„ØªÙ‚Ø±ÙŠØ±");
    XLSX.writeFile(wb, `ØªÙ‚Ø±ÙŠØ±_${t.name.replace(/\s/g,'_')}.xlsx`);
}

function populateSelects(){
  ['attendance_teacher','absence_teacher','report_teacher_select'].forEach(id=>{
    const sel=el('#'+id); if(!sel) return; sel.innerHTML='<option value="">-- Ø§Ø®ØªØ± --</option>';
    state.teachers.forEach(t=> { const o=document.createElement('option'); o.value=t.id; o.textContent=t.name; sel.appendChild(o); });
  });
}
function importTeachersFile(file){
  const reader = new FileReader();
  reader.onload = (e) => {
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, {type:'array'});
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(sheet, {header:1});
    let added=0;
    
    const headers = rows[0] || [];
    let emailIdx = -1;
    rows[0].forEach((h, i) => {
        if(typeof h === 'string' && (h.includes('email') || h.includes('Ø¥ÙŠÙ…ÙŠÙ„') || h.includes('Ø¨Ø±ÙŠØ¯'))) emailIdx = i;
    });

    rows.slice(1).forEach(r=>{
       const name=r[0], id=r[1], sub=r[2];
       let email = '';
       if(emailIdx > -1) email = r[emailIdx];
       if(name && id && !state.teachers.some(t=>t.id==id)){ 
           state.teachers.push({id:String(id), name, subject:sub, email}); 
           added++; 
       }
    });
    save(); renderTeachers(); populateSelects(); toast(`ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${added} Ù…Ø¹Ù„Ù…`);
  };
  reader.readAsArrayBuffer(file);
}

function init(){
  el('#doLogin').onclick = attemptLogin;
  el('#logoutBtn').onclick = doLogout;
  el('#login_pass').addEventListener("keypress", function(event) { if (event.key === "Enter") { event.preventDefault(); el("#doLogin").click(); } });

  load(); bindNav(); bindAbsenceLogic();
  el('#addTeacher').onclick = addTeacher;
  el('#addCi').onclick = addCriterion;
  el('#saveDaily').onclick = ()=> saveGridSession('daily');
  el('#saveWeekly').onclick = ()=> saveGridSession('weekly');
  el('#saveMonthly').onclick = ()=> saveGridSession('monthly');
  el('#saveAttendance').onclick = saveAttendance;
  el('#saveAbsence').onclick = saveAbsence;
  el('#clearAttendance').onclick = async()=>{if(confirm('Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„ØŸ')){ state.attendance=[]; save(); renderAttendanceTable(); }};
  el('#clearAbsence').onclick = async()=>{if(confirm('Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„ØŸ')){ state.absences=[]; save(); renderAbsences(); }};
  
  el('#showReport').onclick = ()=> renderTeacherReport(el('#report_teacher_select').value);
  el('#btnFilterSummary').onclick = renderSummaryReport;
  el('#btnFilterFull').onclick = renderFullReport;
  el('#printReport').onclick = ()=> { renderTeacherReport(el('#report_teacher_select').value); window.print(); };
  el('#printFull').onclick = ()=> window.print();
  el('#printAllReports').onclick = printAllTeachers;
  el('#exportTeacherExcel').onclick = exportSingleTeacherToExcel;
  el('#exportAllExcel').onclick = exportAllTeachersToExcel; // NEW BUTTON BINDING
  
  el('#backup').onclick = ()=> { const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(state)],{type:'application/json'})); a.download='backup.json'; a.click(); };
  el('#backupTop').onclick = el('#backup').onclick;
  el('#restore').onclick = () => el('#restoreFile').click();
  el('#restoreFile').onchange = (e) => {
    const file = e.target.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
        try { state = JSON.parse(ev.target.result); save(); alert('ØªÙ… Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©'); location.reload(); } catch(err) { alert('Ù…Ù„Ù Ø®Ø§Ø·Ø¦'); }
    };
    reader.readAsText(file);
  };
  el('#restoreDefaults').onclick = restoreDefaults;
  el('#btnImportFile').onclick = ()=> el('#importFile').click();
  el('#importFile').onchange = e=> importTeachersFile(e.target.files[0]);
  el('#resetAll').onclick = async()=>{ if(confirm('ØªØµÙÙŠØ± Ø´Ø§Ù…Ù„ØŸ')){ localStorage.removeItem(STORAGE); location.reload(); } };
  
  renderTeachers(); renderCriteria(); populateSelects();
  el('.nav-btn[data-screen="teachers"]').classList.add('active'); el('#teachers').style.display='block';
}

function attemptLogin(){
  const u = el('#login_user').value; const p = el('#login_pass').value;
  if(u === ADMIN_USER && p === ADMIN_PASS){ el('#loginScreen').style.display = 'none'; el('#appContainer').style.display = 'block'; } else { el('#loginError').style.display = 'block'; }
}
function doLogout(){ el('#appContainer').style.display = 'none'; el('#loginScreen').style.display = 'flex'; el('#login_user').value = ''; el('#login_pass').value = ''; el('#loginError').style.display = 'none'; }
function bindNav(){ els('.nav-btn').forEach(b=> b.addEventListener('click', ()=>{ els('.nav-btn').forEach(x=>x.classList.remove('active')); b.classList.add('active'); els('.screen').forEach(s=>s.style.display='none'); el('#'+b.dataset.screen).style.display='block'; if(['daily','weekly','monthly'].includes(b.dataset.screen)) { buildGridForKind(b.dataset.screen); renderSessions(b.dataset.screen); } if(b.dataset.screen==='summaryReport') renderSummaryReport(); if(b.dataset.screen==='fullReport') renderFullReport(); })); }

document.addEventListener('DOMContentLoaded', init);
})();
</script>
</body>
</html>
