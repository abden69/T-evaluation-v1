<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† - Ø¬Ø¯Ø§ÙˆÙ„ ØªÙØµÙŠÙ„ÙŠØ©</title>
  <style>
    :root{--bg:#f7f9ff;--card:#fff;--accent:#0b69ff;--muted:#6b7280}
    *{box-sizing:border-box}
    body{font-family:Tahoma, Arial, sans-serif;background:var(--bg);margin:0;color:#0f1724}
    .app{max-width:980px;margin:0 auto}
    header{background:linear-gradient(90deg,var(--accent),#5aa1ff);color:#fff;padding:12px 14px;display:flex;gap:12px;align-items:center;justify-content:space-between}
    .nav{display:flex;gap:8px;flex-wrap:wrap}
    .nav button{background:transparent;border:0;color:rgba(255,255,255,.95);padding:8px 10px;border-radius:8px;font-weight:700;cursor:pointer;display:flex;gap:8px;align-items:center}
    .nav button.active{background:rgba(255,255,255,.15)}
    main{padding:14px}
    .screen{display:none}
    .screen.active{display:block}
    .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 6px 18px rgba(15,23,36,0.06);margin-bottom:12px}
    label{display:block;margin:8px 0 6px;font-weight:700}
    input[type=text],select,input[type=number],textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #e6eefb}
    .row{display:flex;gap:10px}
    .row > *{flex:1}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .btn{background:var(--accent);color:#fff;padding:10px 12px;border-radius:10px;border:0;cursor:pointer}
    .btn.ghost{background:transparent;color:var(--accent);border:1px solid rgba(11,105,255,.12)}
    .small{font-size:13px;color:var(--muted)}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:8px;text-align:right;border-bottom:1px solid #f1f5f9}
    th{background:#f8fafc}
    .center{text-align:center}
    canvas{max-width:100%;height:260px}
    .criterion-row{display:flex;gap:8px;align-items:center;margin-bottom:8px}
    .criterion-row input[type=number]{width:100px}
    .criterion-label{flex:1}
    .delete-crit{background:#ff6b6b;color:#fff;border:0;padding:6px 8px;border-radius:8px;cursor:pointer}
    .search-input{width:260px;padding:8px;border-radius:8px;border:1px solid #e6eefb}
    .icon-btn{border:0;padding:6px 8px;border-radius:6px;cursor:pointer}
    .edit-btn{background:#0b69ff;color:#fff}
    .del-btn{background:#ff6b6b;color:#fff}
    .save-edit-btn{background:#22c55e;color:#fff}
    .hidden{display:none}
    /* Modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.45);display:none;align-items:center;justify-content:center;z-index:50}
    .modal{background:var(--card);padding:16px;border-radius:12px;max-width:420px;width:95%}
    .modal h4{margin:0 0 8px}
    .modal .row{flex-direction:column}
    .modal .actions{justify-content:flex-end}
    @media(max-width:680px){.row{flex-direction:column}.search-input{width:100%}}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div style="display:flex;gap:12px;align-items:center">
        <div style="font-size:18px;font-weight:800">ğŸ“‹ ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†</div>
        <div class="small">Ù†Ø³Ø®Ø© Ù…Ø­Ù„ÙŠØ© Ù…Ø¹ Ø¬Ø¯Ø§ÙˆÙ„ Ù…ÙØµÙ‘Ù„Ø©</div>
      </div>
      <nav class="nav" aria-label="Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªÙ†Ù‚Ù„">
        <button class="nav-btn active" data-screen="teachers">ğŸ§‘â€ğŸ« Ø§Ù„Ù…Ø¹Ù„Ù…ÙˆÙ†</button>
        <button class="nav-btn" data-screen="daily">ğŸ“… ÙŠÙˆÙ…ÙŠ</button>
        <button class="nav-btn" data-screen="weekly">ğŸ“† Ø£Ø³Ø¨ÙˆØ¹ÙŠ</button>
        <button class="nav-btn" data-screen="monthly">ğŸ—“ï¸ Ø´Ù‡Ø±ÙŠ</button>
        <button class="nav-btn" data-screen="report">ğŸ“Š Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
        <button class="nav-btn" data-screen="settings">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
      </nav>
    </header>

    <main>
      <!-- Ø§Ù„Ù…Ø¹Ù„Ù…ÙˆÙ† -->
      <section id="teachers" class="screen active">
        <div class="card">
          <h3>Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¹Ù„Ù‘Ù…</h3>
          <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
          <input id="t_name" type="text" placeholder="Ù…Ø«Ø§Ù„: Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯">
          <div class="row">
            <div>
              <label>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</label>
              <input id="t_id" type="text" placeholder="Ù…Ø«Ø§Ù„: 12345">
            </div>
            <div>
              <label>Ø§Ù„Ù…Ø§Ø¯Ø©</label>
              <input id="t_subject" type="text" placeholder="Ù…Ø«Ø§Ù„: Ø±ÙŠØ§Ø¶ÙŠØ§Øª">
            </div>
          </div>
          <div class="actions" style="margin-top:10px">
            <button id="addTeacherBtn" class="btn">Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„Ù‘Ù…</button>
            <button id="updateTeacherBtn" class="btn ghost hidden">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
            <button id="clearFormBtn" class="btn ghost">ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„</button>
          </div>
        </div>

        <div class="card">
          <h3>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†</h3>
          <table id="teachersTable">
            <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø±Ù‚Ù…</th><th>Ø§Ù„Ù…Ø§Ø¯Ø©</th><th class="center">Ø¹Ù…Ù„ÙŠØ§Øª</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <!-- ØªÙ‚ÙŠÙŠÙ… ÙŠÙˆÙ…ÙŠ -->
      <section id="daily" class="screen">
        <div class="card">
          <h3>ØªÙ‚ÙŠÙŠÙ… ÙŠÙˆÙ…ÙŠ</h3>
          <label>Ø§Ø®ØªØ± Ù…Ø¹Ù„Ù‘Ù…</label>
          <select id="daily_teacher"></select>

          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
            <label>Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„ØªÙ‚ÙŠÙŠÙ… (1-5)</label>
            <div>
              <button id="addCriterionDaily" class="btn ghost">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø¹ÙŠØ§Ø± Ø¬Ø¯ÙŠØ¯</button>
            </div>
          </div>

          <div id="daily_criteria" style="margin-top:8px"></div>

          <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <textarea id="d_notes" rows="3"></textarea>

          <div class="actions" style="margin-top:10px">
            <button id="saveDaily" class="btn">Ø­ÙØ¸ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</button>
            <button id="saveDailyEdit" class="btn save-edit-btn hidden">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
            <button id="resetDaily" class="btn ghost">ØªÙØ±ÙŠØº</button>
          </div>

          <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ© -->
          <div style="margin-top:12px">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div style="font-weight:700">ğŸ“… Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„ÙŠÙˆÙ…ÙŠ</div>
              <input id="searchDaily" class="search-input" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…...">
            </div>
            <div style="overflow:auto;margin-top:8px">
              <table id="daily_table">
                <thead id="daily_table_head"></thead>
                <tbody id="daily_table_body"></tbody>
              </table>
            </div>
          </div>

        </div>
      </section>

      <!-- ØªÙ‚ÙŠÙŠÙ… Ø§Ø³Ø¨ÙˆØ¹ÙŠ -->
      <section id="weekly" class="screen">
        <div class="card">
          <h3>ØªÙ‚ÙŠÙŠÙ… Ø£Ø³Ø¨ÙˆØ¹ÙŠ</h3>
          <label>Ø§Ø®ØªØ± Ù…Ø¹Ù„Ù‘Ù…</label>
          <select id="weekly_teacher"></select>

          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
            <label>Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„ØªÙ‚ÙŠÙŠÙ… (1-5)</label>
            <div>
              <button id="addCriterionWeekly" class="btn ghost">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø¹ÙŠØ§Ø± Ø¬Ø¯ÙŠØ¯</button>
            </div>
          </div>

          <div id="weekly_criteria" style="margin-top:8px"></div>

          <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <textarea id="w_notes" rows="3"></textarea>

          <div class="actions" style="margin-top:10px">
            <button id="saveWeekly" class="btn">Ø­ÙØ¸ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</button>
            <button id="saveWeeklyEdit" class="btn save-edit-btn hidden">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
            <button id="resetWeekly" class="btn ghost">ØªÙØ±ÙŠØº</button>
          </div>

          <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ© -->
          <div style="margin-top:12px">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div style="font-weight:700">ğŸ“† Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ</div>
              <input id="searchWeekly" class="search-input" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…...">
            </div>
            <div style="overflow:auto;margin-top:8px">
              <table id="weekly_table">
                <thead id="weekly_table_head"></thead>
                <tbody id="weekly_table_body"></tbody>
              </table>
            </div>
          </div>

        </div>
      </section>

      <!-- ØªÙ‚ÙŠÙŠÙ… Ø´Ù‡Ø±ÙŠ -->
      <section id="monthly" class="screen">
        <div class="card">
          <h3>ØªÙ‚ÙŠÙŠÙ… Ø´Ù‡Ø±ÙŠ</h3>
          <label>Ø§Ø®ØªØ± Ù…Ø¹Ù„Ù‘Ù…</label>
          <select id="monthly_teacher"></select>

          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
            <label>Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„ØªÙ‚ÙŠÙŠÙ… (1-5)</label>
            <div>
              <button id="addCriterionMonthly" class="btn ghost">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø¹ÙŠØ§Ø± Ø¬Ø¯ÙŠØ¯</button>
            </div>
          </div>

          <div id="monthly_criteria" style="margin-top:8px"></div>

          <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <textarea id="m_notes" rows="3"></textarea>

          <div class="actions" style="margin-top:10px">
            <button id="saveMonthly" class="btn">Ø­ÙØ¸ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</button>
            <button id="saveMonthlyEdit" class="btn save-edit-btn hidden">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
            <button id="resetMonthly" class="btn ghost">ØªÙØ±ÙŠØº</button>
          </div>

          <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ© -->
          <div style="margin-top:12px">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div style="font-weight:700">ğŸ—“ï¸ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø´Ù‡Ø±ÙŠ</div>
              <input id="searchMonthly" class="search-input" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…...">
            </div>
            <div style="overflow:auto;margin-top:8px">
              <table id="monthly_table">
                <thead id="monthly_table_head"></thead>
                <tbody id="monthly_table_body"></tbody>
              </table>
            </div>
          </div>

        </div>
      </section>

      <!-- Ø§Ù„ØªÙ‚Ø±ÙŠØ± -->
      <section id="report" class="screen">
        <div class="card">
          <h3>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø¯Ø§Ø¡</h3>
          <div class="small">Ø§Ù„ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø£Ø¹Ù„Ù‰ Ù…ØªÙˆØ³Ø· ØªÙ‚ÙŠÙŠÙ… (Ø§Ù„Ù…Ø¹Ø§Ù…Ù„: Ø§Ù„Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¨Ø³ÙŠØ· Ù„ÙƒÙ„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª)</div>
          <table id="reportTable"><thead><tr><th>Ø§Ù„Ù…Ø¹Ù„Ù…</th><th>Ø§Ù„Ø±Ù‚Ù…</th><th>Ù…Ø§Ø¯Ø©</th><th>Ù…ØªÙˆØ³Ø· ÙŠÙˆÙ…ÙŠ</th><th>Ù…ØªÙˆØ³Ø· Ø£Ø³Ø¨ÙˆØ¹ÙŠ</th><th>Ù…ØªÙˆØ³Ø· Ø´Ù‡Ø±ÙŠ</th><th>Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¹Ø§Ù…</th></tr></thead><tbody></tbody></table>
          <div style="margin-top:12px">
            <canvas id="chart"></canvas>
          </div>
        </div>
      </section>

      <!-- Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
      <section id="settings" class="screen">
        <div class="card">
          <h3>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h3>
          <p class="small">Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­. Ù„Ø§Ø­Ù‚Ø§Ù‹ ÙŠÙ…ÙƒÙ† Ø±Ø¨Ø· Google Sheets.</p>
          <div class="actions" style="margin-top:10px">
            <button id="backupBtn" class="btn">Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ (Download JSON)</button>
            <button id="restoreBtn" class="btn ghost">Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ù…Ù† JSON</button>
            <button id="clearAllData" class="btn ghost" style="background:#ff6b6b;color:#fff">Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
          </div>
        </div>
      </section>

    </main>
  </div>

  <!-- Modal -->
  <div id="modalBackdrop" class="modal-backdrop">
    <div class="modal">
      <h4>Ø¥Ø¶Ø§ÙØ© Ù…Ø¹ÙŠØ§Ø± Ø¬Ø¯ÙŠØ¯</h4>
      <div class="row">
        <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¹ÙŠØ§Ø±</label>
        <input id="newCritName" type="text" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ø§Ù†Ø¶Ø¨Ø§Ø·">
        <label>Ù†ÙˆØ¹ Ø§Ù„Ù…Ø¹ÙŠØ§Ø±</label>
        <select id="newCritKind">
          <option value="daily">ÙŠÙˆÙ…ÙŠ</option>
          <option value="weekly">Ø£Ø³Ø¨ÙˆØ¹ÙŠ</option>
          <option value="monthly">Ø´Ù‡Ø±ÙŠ</option>
        </select>
      </div>
      <div class="actions" style="margin-top:10px">
        <button id="saveNewCrit" class="btn">Ø­ÙØ¸</button>
        <button id="cancelNewCrit" class="btn ghost">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const STORAGE_KEY = 'teachers_evals_v3';
    let state = {teachers:[], evaluations:[], criteria:{}};
    const DEFAULT_CRITERIA = { daily:[{id:'d_attendance',name:'Ø§Ù„Ø­Ø¶ÙˆØ±'},{id:'d_organization',name:'ØªÙ†Ø¸ÙŠÙ… Ø§Ù„Ø­ØµØ©'}], weekly:[{id:'w_participation',name:'Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„ØµÙÙŠØ©'},{id:'w_preparation',name:'Ø§Ù„ØªØ­Ø¶ÙŠØ±'}], monthly:[{id:'m_outcomes',name:'Ø§Ù„Ù…Ø®Ø±Ø¬Ø§Øª Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©'},{id:'m_commitment',name:'Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª'}] };

    // load / save
    function loadState(){ try{ const raw = localStorage.getItem(STORAGE_KEY); if(raw) state = JSON.parse(raw); else { state = {teachers:[], evaluations:[], criteria:DEFAULT_CRITERIA}; saveState(); } } catch(e){ state = {teachers:[], evaluations:[], criteria:DEFAULT_CRITERIA}; saveState(); } }
    function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

    // nav
    document.querySelectorAll('.nav-btn').forEach(b=>b.addEventListener('click',()=>{ document.querySelectorAll('.nav-btn').forEach(x=>x.classList.remove('active')); b.classList.add('active'); showScreen(b.dataset.screen); }));
    function showScreen(id){ document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); document.getElementById(id).classList.add('active'); if(id==='teachers') renderTeachersTable(); if(['daily','weekly','monthly'].includes(id)){ populateTeacherSelects(); renderCriteriaForKind(id); renderRecords(id); } if(id==='report') renderReport(); }

    // teachers
    function renderTeachersTable(){ const tbody = document.querySelector('#teachersTable tbody'); tbody.innerHTML=''; state.teachers.forEach(t=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${t.name}</td><td>${t.id}</td><td>${t.subject||''}</td><td class='center'><button class='btn ghost' data-action='edit' data-id='${t.id}'>ØªØ¹Ø¯ÙŠÙ„</button> <button class='btn ghost' style='background:#ff6b6b;color:#fff' data-action='del' data-id='${t.id}'>Ø­Ø°Ù</button></td>`; tbody.appendChild(tr); }); tbody.querySelectorAll('button').forEach(btn=>btn.addEventListener('click',()=>{ const id=btn.dataset.id; const action=btn.dataset.action; if(action==='edit') startEditTeacher(id); if(action==='del' && confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù…Ø¹Ù„Ù‘Ù… ÙˆØ¬Ù…ÙŠØ¹ ØªÙ‚ÙŠÙŠÙ…Ø§ØªÙ‡ØŸ')) deleteTeacher(id); })); }
    function addTeacher(){ const name=document.getElementById('t_name').value.trim(); const id=document.getElementById('t_id').value.trim(); const subject=document.getElementById('t_subject').value.trim(); if(!name||!id){ alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø±Ù‚Ù…'); return; } if(state.teachers.some(x=>x.id===id)){ alert('Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ Ù…ÙˆØ¬ÙˆØ¯'); return; } state.teachers.push({id,name,subject}); saveState(); renderTeachersTable(); clearTeacherForm(); alert('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ù„Ù…'); }
    function startEditTeacher(id){ const t=state.teachers.find(x=>x.id===id); if(!t) return; document.getElementById('t_name').value=t.name; document.getElementById('t_id').value=t.id; document.getElementById('t_subject').value=t.subject||''; document.getElementById('addTeacherBtn').classList.add('hidden'); document.getElementById('updateTeacherBtn').classList.remove('hidden'); document.getElementById('t_id').disabled=true; document.getElementById('updateTeacherBtn').onclick = function(){ updateTeacher(); }; }
    function updateTeacher(){ const id=document.getElementById('t_id').value.trim(); const t=state.teachers.find(x=>x.id===id); if(!t) return; t.name=document.getElementById('t_name').value.trim(); t.subject=document.getElementById('t_subject').value.trim(); saveState(); renderTeachersTable(); clearTeacherForm(); alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„'); }
    function clearTeacherForm(){ document.getElementById('t_name').value=''; document.getElementById('t_id').value=''; document.getElementById('t_subject').value=''; document.getElementById('t_id').disabled=false; document.getElementById('addTeacherBtn').classList.remove('hidden'); document.getElementById('updateTeacherBtn').classList.add('hidden'); }
    function deleteTeacher(id){ state.teachers = state.teachers.filter(t=>t.id!==id); state.evaluations = state.evaluations.filter(ev=>ev.teacherId!==id); saveState(); renderTeachersTable(); alert('ØªÙ… Ø§Ù„Ø­Ø°Ù'); }

    document.getElementById('addTeacherBtn').addEventListener('click',addTeacher); document.getElementById('clearFormBtn').addEventListener('click',clearTeacherForm);

    // populate selects
    function populateTeacherSelects(){ ['daily_teacher','weekly_teacher','monthly_teacher'].forEach(selId=>{ const sel=document.getElementById(selId); sel.innerHTML=''; state.teachers.forEach(t=>{ const opt=document.createElement('option'); opt.value=t.id; opt.textContent = `${t.name} â€” ${t.subject||t.id}`; sel.appendChild(opt); }); }); }

    // criteria dynamic
    function renderCriteriaForKind(kind){ const container=document.getElementById(kind+'_criteria'); container.innerHTML=''; const list = state.criteria[kind] || []; if(list.length===0){ container.innerHTML='<div class="small">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§ÙŠÙŠØ± Ø¨Ø¹Ø¯. Ø£Ø¶Ù Ù…Ø¹ÙŠØ§Ø±Ø§Ù‹ Ø¬Ø¯ÙŠØ¯Ø§Ù‹.</div>'; return; } list.forEach(crit=>{ const row=document.createElement('div'); row.className='criterion-row'; row.innerHTML = `<div class='criterion-label'>${crit.name}</div><input type='number' min='1' max='5' value='5' data-crit-id='${crit.id}' class='crit-input'> <button class='delete-crit' data-kind='${kind}' data-id='${crit.id}'>ğŸ—‘ï¸</button>`; container.appendChild(row); }); container.querySelectorAll('.delete-crit').forEach(b=>b.addEventListener('click',()=>{ const id=b.dataset.id; const k=b.dataset.kind; if(!confirm('Ø­Ø°Ù Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø³ÙŠØ¤Ø«Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„ÙƒÙ†Ù‡ Ù„Ù† ÙŠØºÙŠÙ‘Ø± Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©. Ù…ÙˆØ§ÙÙ‚ØŸ')) return; removeCriterion(k,id); renderCriteriaForKind(k); renderRecords(k); })); }
    function openNewCriterionModal(kind){ document.getElementById('modalBackdrop').style.display='flex'; document.getElementById('newCritKind').value = kind; document.getElementById('newCritName').value=''; document.getElementById('newCritName').focus(); }
    function closeNewCriterionModal(){ document.getElementById('modalBackdrop').style.display='none'; }
    function saveNewCriterion(){ const name=document.getElementById('newCritName').value.trim(); const kind=document.getElementById('newCritKind').value; if(!name){ alert('Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø¹ÙŠØ§Ø±'); return; } const id = kind.charAt(0)+'_'+Date.now().toString(36).slice(2); state.criteria[kind]=state.criteria[kind]||[]; state.criteria[kind].push({id,name}); saveState(); closeNewCriterionModal(); renderCriteriaForKind(kind); renderRecords(kind); alert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹ÙŠØ§Ø±'); }
    function removeCriterion(kind,id){ state.criteria[kind] = (state.criteria[kind]||[]).filter(c=>c.id!==id); saveState(); }
    document.getElementById('addCriterionDaily').addEventListener('click',()=>openNewCriterionModal('daily')); document.getElementById('addCriterionWeekly').addEventListener('click',()=>openNewCriterionModal('weekly')); document.getElementById('addCriterionMonthly').addEventListener('click',()=>openNewCriterionModal('monthly')); document.getElementById('cancelNewCrit').addEventListener('click',closeNewCriterionModal); document.getElementById('saveNewCrit').addEventListener('click',saveNewCriterion);

    // collect values
    function collectCriteriaValues(kind){ const container=document.getElementById(kind+'_criteria'); const inputs = container.querySelectorAll('input[data-crit-id]'); const obj={}; inputs.forEach(inp=>{ obj[inp.dataset.critId] = Number(inp.value) || 0; }); return obj; }

    // records (evaluations): add / render / edit / delete
    function addRecord(kind){ const sel = document.getElementById(kind+'_teacher'); if(!sel.value) return alert('Ø§Ø®ØªØ± Ù…Ø¹Ù„Ù…Ø§Ù‹'); const teacherId = sel.value; const notes = document.getElementById((kind==='daily'?'d':(kind==='weekly'?'w':'m'))+'_notes').value || ''; const criteriaValues = collectCriteriaValues(kind); const rec = { id: Date.now()+Math.random().toString(36).slice(2), teacherId, criteria: criteriaValues, notes, date: new Date().toISOString() }; state.evaluations.push({...rec, kind}); saveState(); renderRecords(kind); alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…'); }
    function renderRecords(kind,filter=''){ // build table head and body
      const head = document.getElementById(kind+'_table_head'); const body = document.getElementById(kind+'_table_body'); head.innerHTML=''; body.innerHTML=''; const crits = state.criteria[kind]||[];
      // header
      const trh = document.createElement('tr'); trh.innerHTML = `<th>Ø§Ù„Ù…Ø¹Ù„Ù…</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>`;
      crits.forEach(c=> trh.innerHTML += `<th>${c.name}</th>`);
      trh.innerHTML += `<th>Ø§Ù„Ù…ØªÙˆØ³Ø·</th><th class='center'>ØªØ¹Ø¯ÙŠÙ„</th><th class='center'>Ø­Ø°Ù</th>`; head.appendChild(trh);
      // rows
      const rows = state.evaluations.filter(e=>e.kind===kind).filter(e=>{ if(!filter) return true; const t = state.teachers.find(tt=>tt.id===e.teacherId); return t && t.name.toLowerCase().includes(filter.toLowerCase()); });
      rows.forEach((r,idx)=>{
        const tr = document.createElement('tr'); const teacher = state.teachers.find(t=>t.id===r.teacherId) || {name:'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}; const avg = avgObjectValues(r.criteria);
        let inner = `<td>${teacher.name}</td><td>${new Date(r.date).toLocaleString()}</td>`;
        crits.forEach(c=>{ inner += `<td>${r.criteria[c.id] !== undefined ? r.criteria[c.id] : '-'}</td>`; });
        inner += `<td class='center'>${avg}</td>`;
        inner += `<td class='center'><button class='icon-btn edit-btn' data-kind='${kind}' data-id='${r.id}'>âœï¸</button></td>`;
        inner += `<td class='center'><button class='icon-btn del-btn' data-kind='${kind}' data-id='${r.id}'>ğŸ—‘ï¸</button></td>`;
        tr.innerHTML = inner; body.appendChild(tr);
      });
      // attach events
      body.querySelectorAll('.edit-btn').forEach(b=>b.addEventListener('click',()=>{ const id=b.dataset.id; startEditRecord(kind,id); }));
      body.querySelectorAll('.del-btn').forEach(b=>b.addEventListener('click',()=>{ const id=b.dataset.id; if(!confirm('Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ØŸ')) return; deleteRecord(kind,id); }));
    }
    function avgObjectValues(obj){ const vals = Object.values(obj||{}).map(v=>Number(v)||0); if(!vals.length) return 0; return Math.round((vals.reduce((a,b)=>a+b,0)/vals.length)*100)/100; }

    // edit flow
    let currentEdit = {kind:null,id:null};
    function startEditRecord(kind,id){ const rec = state.evaluations.find(e=>e.id===id && e.kind===kind); if(!rec) return; const sel = document.getElementById(kind+'_teacher'); sel.value = rec.teacherId; // fill criteria
      Object.keys(rec.criteria||{}).forEach(cid=>{ const inp = document.querySelector(`#${kind}_criteria input[data-crit-id='${cid}']`); if(inp) inp.value = rec.criteria[cid]; });
      document.getElementById((kind==='daily'?'d':(kind==='weekly'?'w':'m'))+'_notes').value = rec.notes || '';
      // show save edit button
      document.getElementById('save'+ capitalize(kind) + 'Edit').classList.remove('hidden'); document.getElementById('save'+ capitalize(kind)).classList.add('hidden');
      currentEdit = {kind,id};
    }
    function saveEditRecord(){ const kind = currentEdit.kind; if(!kind) return; const id=currentEdit.id; const sel = document.getElementById(kind+'_teacher'); const teacherId = sel.value; const notes = document.getElementById((kind==='daily'?'d':(kind==='weekly'?'w':'m'))+'_notes').value || ''; const criteriaValues = collectCriteriaValues(kind); const idx = state.evaluations.findIndex(e=>e.id===id && e.kind===kind); if(idx===-1) return; state.evaluations[idx].teacherId = teacherId; state.evaluations[idx].criteria = criteriaValues; state.evaluations[idx].notes = notes; state.evaluations[idx].date = new Date().toISOString(); saveState(); renderRecords(kind); // reset form buttons
      document.getElementById('save'+ capitalize(kind) + 'Edit').classList.add('hidden'); document.getElementById('save'+ capitalize(kind)).classList.remove('hidden'); // clear fields
      document.getElementById((kind==='daily'?'d':(kind==='weekly'?'w':'m'))+'_notes').value=''; document.querySelectorAll(`#${kind}_criteria input[data-crit-id]`).forEach(i=>i.value=5);
      currentEdit = {kind:null,id:null}; alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„'); }
    function deleteRecord(kind,id){ state.evaluations = state.evaluations.filter(e=>!(e.id===id && e.kind===kind)); saveState(); renderRecords(kind); }

    // save buttons
    document.getElementById('saveDaily').addEventListener('click',()=>addRecord('daily'));
    document.getElementById('saveWeekly').addEventListener('click',()=>addRecord('weekly'));
    document.getElementById('saveMonthly').addEventListener('click',()=>addRecord('monthly'));
    document.getElementById('saveDailyEdit').addEventListener('click',saveEditRecord);
    document.getElementById('saveWeeklyEdit').addEventListener('click',saveEditRecord);
    document.getElementById('saveMonthlyEdit').addEventListener('click',saveEditRecord);

    // search
    document.getElementById('searchDaily').addEventListener('input',e=>renderRecords('daily',e.target.value));
    document.getElementById('searchWeekly').addEventListener('input',e=>renderRecords('weekly',e.target.value));
    document.getElementById('searchMonthly').addEventListener('input',e=>renderRecords('monthly',e.target.value));

    // reset helpers
    document.getElementById('resetDaily').addEventListener('click',()=>{ document.querySelectorAll('#daily_criteria input[data-crit-id]').forEach(i=>i.value=5); document.getElementById('d_notes').value=''; });
    document.getElementById('resetWeekly').addEventListener('click',()=>{ document.querySelectorAll('#weekly_criteria input[data-crit-id]').forEach(i=>i.value=5); document.getElementById('w_notes').value=''; });
    document.getElementById('resetMonthly').addEventListener('click',()=>{ document.querySelectorAll('#monthly_criteria input[data-crit-id]').forEach(i=>i.value=5); document.getElementById('m_notes').value=''; });

    // report
    let chartInstance = null;
    function renderReport(){ const tbody=document.querySelector('#reportTable tbody'); tbody.innerHTML=''; const report = state.teachers.map(t=>{ const evs = state.evaluations.filter(e=>e.teacherId===t.id); const daily = evs.filter(e=>e.kind==='daily').map(e=>avgObjectValues(e.criteria)); const weekly = evs.filter(e=>e.kind==='weekly').map(e=>avgObjectValues(e.criteria)); const monthly = evs.filter(e=>e.kind==='monthly').map(e=>avgObjectValues(e.criteria)); const avgDaily = daily.length?average(daily):0; const avgWeekly = weekly.length?average(weekly):0; const avgMonthly = monthly.length?average(monthly):0; const counts=[avgDaily>0,avgWeekly>0,avgMonthly>0].filter(x=>x).length||1; const general = Math.round(((avgDaily+avgWeekly+avgMonthly)/counts)*100)/100; return {id:t.id,name:t.name,subject:t.subject||'',avgDaily,avgWeekly,avgMonthly,general}; }); report.sort((a,b)=>b.general-a.general); report.forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.name}</td><td>${r.id}</td><td>${r.subject}</td><td class='center'>${round(r.avgDaily)}</td><td class='center'>${round(r.avgWeekly)}</td><td class='center'>${round(r.avgMonthly)}</td><td class='center'>${r.general}</td>`; tbody.appendChild(tr); }); const labels = report.map(r=>r.name+' ('+r.id+')'); const data = report.map(r=>r.general); const ctx = document.getElementById('chart').getContext('2d'); if(chartInstance) chartInstance.destroy(); chartInstance = new Chart(ctx,{type:'bar',data:{labels,datasets:[{label:'Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¹Ø§Ù…',data}]},options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,max:5}}}}); }
    function average(arr){ if(!arr||!arr.length) return 0; return arr.reduce((a,b)=>a+b,0)/arr.length; }
    function round(v){ return v?Math.round(v*100)/100:0; }

    // backup/restore/clear
    document.getElementById('backupBtn').addEventListener('click',()=>{ const dataStr = JSON.stringify(state,null,2); const blob = new Blob([dataStr],{type:'application/json'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='teachers_evals_backup.json'; a.click(); URL.revokeObjectURL(url); });
    document.getElementById('restoreBtn').addEventListener('click',()=>{ const input=document.createElement('input'); input.type='file'; input.accept='application/json'; input.onchange=e=>{ const file=e.target.files[0]; if(!file) return; const reader=new FileReader(); reader.onload=evt=>{ try{ const obj=JSON.parse(evt.target.result); if(obj.teachers && obj.evaluations && obj.criteria){ state=obj; saveState(); init(); alert('ØªÙ… Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹'); } else alert('Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­'); } catch(err){ alert('Ø®Ø·Ø£'); } }; reader.readAsText(file); }; input.click(); });
    document.getElementById('clearAllData').addEventListener('click',()=>{ if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ')){ state={teachers:[], evaluations:[], criteria:DEFAULT_CRITERIA}; saveState(); init(); alert('ØªÙ… Ø§Ù„Ù…Ø³Ø­'); } });

    // util
    function capitalize(s){ return s.charAt(0).toUpperCase()+s.slice(1); }

    // init
    function init(){ loadState(); renderTeachersTable(); populateTeacherSelects(); renderCriteriaForKind('daily'); renderCriteriaForKind('weekly'); renderCriteriaForKind('monthly'); renderRecords('daily'); renderRecords('weekly'); renderRecords('monthly'); renderReport(); }
    init();
  </script>
</body>
</html>