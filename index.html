<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ù†Ø¸Ø§Ù… ØªÙ‚ÙŠÙŠÙ… Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† â€” Ø§Ù„Ø¥ØµØ¯Ø§Ø± 26</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
<style>
    /* ===========================
       Theme: Official Emerald Green
       index25_full - Part 1 (styles + layout)
       =========================== */
    :root{
      --bg:#f8f9f8;           /* very light background */
      --card:#ffffff;         /* card background */
      --emerald-dark:#0f5132; /* headings / topbar */
      --emerald:#198754;      /* main button/accent */
      --emerald-2:#2ea26d;    /* accent lighter */
      --table-head:#e9f5ec;   /* table header light green */
      --muted:#4f5d52;        /* secondary text */
      --danger:#d9534f;
      --gold-highlight:#fff7e6; 
      --gold-border: rgba(255,170,0,0.12);
      --shadow: 0 10px 30px rgba(15,81,50,0.06);
      --radius: 10px;
      --glass: rgba(255,255,255,0.75);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      font-family:'Cairo',sans-serif;
      color:#071123;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      line-height:1.5;
    }
    
    /* container */
    .container{
      max-width:1200px;
      margin:18px auto;
      padding:18px;
    }
    
    /* Top header */
    .header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      padding:16px 18px;
      border-radius:var(--radius);
      background: linear-gradient(90deg,var(--emerald),var(--emerald-2));
      color: #fff;
      box-shadow: var(--shadow);
    }
    .header .title{
      font-weight:900;
      font-size:1.05rem;
      letter-spacing:0.2px;
    }
    .header .subtitle{
      font-weight:700;
      font-size:0.86rem;
      opacity:0.95;
    }
    
    /* nav pills */
    .nav{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:14px;
    }
    .nav button{
      background:transparent;
      border:0;
      padding:8px 12px;
      border-radius:8px;
      cursor:pointer;
      font-weight:800;
      color:var(--emerald-dark);
      transition: all 200ms ease;
    }
    .nav button:hover{
      transform:translateY(-3px);
      color:var(--emerald);
    }
    .nav button.active{
      background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,255,255,0.86));
      box-shadow: 0 8px 18px rgba(15,81,50,0.06);
    }
    
    /* card style */
    .card{
      background:var(--card);
      padding:14px;
      border-radius:var(--radius);
      margin-top:12px;
      box-shadow: 0 8px 26px rgba(10,25,18,0.03);
      border: 1px solid rgba(15,81,50,0.03);
    }
    
    /* forms & inputs */
    input,select,textarea{
      width:100%;
      padding:10px 12px;
      border-radius:8px;
      border:1px solid #e6efe8;
      background: linear-gradient(180deg, #fff, #fbfdfb);
      outline:none;
      transition: box-shadow 160ms ease, transform 120ms ease;
    }
    input:focus, select:focus, textarea:focus{
      box-shadow: 0 6px 18px rgba(25,135,84,0.08);
      transform: translateY(-1px);
      border-color: var(--emerald-2);
    }
    
    /* rows */
    .row{ display:flex; gap:10px }
    .row> *{ flex:1 }
    
    /* buttons */
    .btn{
      display:inline-flex;
      gap:8px;
      align-items:center;
      justify-content:center;
      padding:9px 14px;
      border-radius:9px;
      border:0;
      cursor:pointer;
      font-weight:800;
      color:#fff;
      background: linear-gradient(90deg,var(--emerald),var(--emerald-2));
      box-shadow: 0 8px 20px rgba(15,81,50,0.08);
      transition: transform 180ms cubic-bezier(.2,.9,.2,1), box-shadow 180ms;
    }
    .btn:hover{
      transform: translateY(-4px);
      box-shadow: 0 16px 36px rgba(15,81,50,0.12);
    }
    .btn.ghost{
      background: transparent;
      color: var(--emerald-dark);
      border:1px solid rgba(15,81,50,0.06);
      box-shadow:none;
    }
    .btn.danger{
      background: linear-gradient(90deg,#e64a3c,#d9534f);
      color:#fff;
    }
    
    /* table */
    .table{
      width:100%;
      border-collapse:collapse;
      margin-top:10px;
      font-size:0.95rem;
    }
    .table th, .table td{
      padding:10px;
      text-align:right;
      vertical-align:middle;
      border-bottom:1px solid #f1f6f1;
    }
    .table th{
      background:var(--table-head);
      font-weight:900;
      color:var(--emerald-dark);
      position:sticky;
      top:0;
      z-index:2;
    }
    .table td.center{ text-align:center }
    .table td.left{ text-align:left; direction:ltr }
    
    /* highlights */
    .highlight-best{
      background: linear-gradient(90deg,#fefbe8,#fff6e4);
      padding:10px;
      border-radius:8px;
      border:1px solid rgba(255,200,0,0.12);
      margin-top:10px;
      font-weight:900;
      color:#5a360a;
    }
    
    /* gold row for top performer */
    .gold-row{
      background: var(--gold-highlight) !important;
      border:1px solid var(--gold-border);
    }
    
    /* small helpers */
    .small{ font-size:13px; color:var(--muted) }
    
    /* responsive */
    @media(max-width:900px){
      .row{ flex-direction:column }
      .header{ flex-direction:column; align-items:flex-start; gap:8px }
    }
    
    /* subtle heading hover (for title interactions) */
    .hov-title{
      display:inline-block;
      transition: color 220ms ease, transform 180ms ease;
      color: var(--emerald-dark);
      font-weight:900;
    }
    .hov-title:hover{
      color: var(--emerald);
      transform: translateY(-3px);
    }
    
    /* canvas area */
    .canvas-wrap{
      display:flex;
      justify-content:center;
      align-items:center;
      padding:12px;
      background:var(--card);
      border-radius:8px;
      margin-top:12px;
      box-shadow: 0 6px 18px rgba(10,25,18,0.02);
    }
    
    /* toast */
    .toast{
      position:fixed;
      top:18px;
      right:18px;
      padding:12px 16px;
      border-radius:10px;
      background: linear-gradient(90deg,var(--emerald),var(--emerald-2));
      color:#fff;
      font-weight:800;
      display:none;
      z-index:9999;
      box-shadow: 0 8px 28px rgba(15,81,50,0.12);
    }
    
    /* modal backdrop */
    .modal-backdrop{
      position:fixed; inset:0;
      background: rgba(2,6,8,0.45);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:2000;
    }
    .modal{
      background:var(--card);
      padding:16px;
      border-radius:10px;
      max-width:760px;
      width:94%;
      box-shadow: 0 18px 44px rgba(10,25,18,0.06);
    }
    
    /* subtle link style */
    .linkish{ color:var(--emerald); text-decoration:underline; cursor:pointer; font-weight:700 }
    </style>  
</head>
<body class="smooth-scroll">
<div class="container">
  <header class="header" role="banner">
    <div class="title">ğŸ“ Ù†Ø¸Ø§Ù… ØªÙ‚ÙŠÙŠÙ… Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† â€” Ø§Ù„Ø¥ØµØ¯Ø§Ø± 26</div>
    <div style="display:flex;gap:8px;align-items:center"><button id="backupTop" class="btn ghost">ğŸ’¾</button></div>
  </header>

  <nav class="nav" id="mainNav" role="navigation" aria-label="Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ">
    <button class="nav-btn" data-screen="teachers">Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†</button>
    <button class="nav-btn" data-screen="criteria">Ø¨Ù†ÙˆØ¯ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</button>
    <button class="nav-btn" data-screen="daily">Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„ÙŠÙˆÙ…ÙŠ</button>
    <button class="nav-btn" data-screen="weekly">Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ</button>
    <button class="nav-btn" data-screen="monthly">Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø´Ù‡Ø±ÙŠ</button>
    <button class="nav-btn" data-screen="attendance">Ø§Ù„Ø­Ø¶ÙˆØ±</button>
    <button class="nav-btn" data-screen="absences">Ø§Ù„ØºÙŠØ§Ø¨</button>
    <button class="nav-btn" data-screen="summaryReport">ğŸ“Š Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø®ØªØµØ±</button>
    <button class="nav-btn" data-screen="fullReport">Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ø§Ù…Ù„</button>
    <button class="nav-btn" data-screen="settings">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
  </nav>

  <!-- Teachers -->
  <section id="teachers" class="card screen" style="display:none" aria-labelledby="teachersTitle">
    <h3 id="teachersTitle">Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†</h3>
    <label class="small">Ø§Ù„Ø§Ø³Ù…</label><input id="t_name" aria-label="Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…">
    <div class="row" style="margin-top:8px"><div><label class="small">Ø§Ù„Ø±Ù‚Ù…</label><input id="t_id" aria-label="Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ù„Ù…"></div><div><label class="small">Ø§Ù„Ù…Ø§Ø¯Ø©</label><input id="t_subject" aria-label="Ø§Ù„ØªØ®ØµØµ"></div></div>

    <!-- Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ© ÙˆØ²Ø± Ø§Ø³ØªÙŠØ±Ø§Ø¯ Excel/CSV -->
    <div style="margin-top:8px; display:flex; gap:8px; align-items:center;">
      <button id="addTeacher" class="btn">Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„Ù‘Ù…</button>
      <input type="file" id="importFile" accept=".xlsx,.xls,.csv" style="display:none">
      <button id="btnImportFile" class="btn ghost">ğŸ“‚ ØªØ­Ù…ÙŠÙ„ Ù…Ù† Excel/CSV</button>
    </div>

    <div style="margin-top:12px"><table class="table" id="teachersTable" aria-label="Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†"><thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø±Ù‚Ù…</th><th>Ø§Ù„Ù…Ø§Ø¯Ø©</th><th>Ø¹Ù…Ù„ÙŠØ§Øª</th></tr></thead><tbody></tbody></table></div>
  </section>
  <!-- Criteria -->
  <section id="criteria" class="card screen" style="display:none" aria-labelledby="criteriaTitle">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <h3 id="criteriaTitle">Ø¨Ù†ÙˆØ¯ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</h3>
        <div class="small">Ø£Ø¶Ù Ø¨Ù†ÙˆØ¯ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… ÙˆØ­Ø¯Ø¯ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ ÙˆÙ†ÙˆØ¹ Ø§Ù„Ø¨Ù†Ø¯ (ÙŠÙˆÙ…ÙŠ/Ø£Ø³Ø¨ÙˆØ¹ÙŠ/Ø´Ù‡Ø±ÙŠ)</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="restoreDefaults" class="btn ghost">ğŸ”„ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©</button>
      </div>
    </div>

    <div style="margin-top:12px">
      <div class="row">
        <div>
          <label class="small">Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ø¯</label>
          <input id="ci_name" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ø­Ø¶ÙˆØ±">
        </div>
        <div>
          <label class="small">Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¹Ù„Ù‰</label>
          <input id="ci_max" type="number" min="1" value="10">
        </div>
        <div>
          <label class="small">Ù†ÙˆØ¹ Ø§Ù„Ø¨Ù†Ø¯</label>
          <select id="ci_kind"><option value="daily">ÙŠÙˆÙ…ÙŠ</option><option value="weekly">Ø£Ø³Ø¨ÙˆØ¹ÙŠ</option><option value="monthly">Ø´Ù‡Ø±ÙŠ</option></select>
        </div>
      </div>
      <div style="margin-top:8px"><button id="addCi" class="btn">â• Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯ Ø¬Ø¯ÙŠØ¯</button></div>

      <div style="margin-top:12px"><table class="table" id="ci_table"><thead><tr><th>Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ø¯</th><th>Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø¹Ù…Ù„ÙŠØ§Øª</th></tr></thead><tbody></tbody></table></div>
    </div>
  </section>

  <!-- Daily -->
  <section id="daily" class="card screen" style="display:none">
    <h3>Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„ÙŠÙˆÙ…ÙŠ</h3>
    <label class="small">Ø§Ø®ØªØ± Ù…Ø¹Ù„Ù‘Ù…</label><select id="daily_teacher"></select>
    <div id="daily_wrap" style="margin-top:8px"></div>
    <div style="margin-top:8px"><button id="saveDaily" class="btn">ØªØ³Ø¬ÙŠÙ„ Ø®ØµÙˆÙ…Ø§Øª (Ø¬Ù„Ø³Ø© Ø¬Ø¯ÙŠØ¯Ø©)</button></div>
    <div style="margin-top:12px"><table class="table" id="daily_table"><thead id="daily_head"></thead><tbody id="daily_body"></tbody></table></div>
  </section>

  <!-- Weekly -->
  <section id="weekly" class="card screen" style="display:none">
    <h3>Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ</h3>
    <label class="small">Ø§Ø®ØªØ± Ù…Ø¹Ù„Ù‘Ù…</label><select id="weekly_teacher"></select>
    <div id="weekly_wrap" style="margin-top:8px"></div>
    <div style="margin-top:8px"><button id="saveWeekly" class="btn">ØªØ³Ø¬ÙŠÙ„ Ø®ØµÙˆÙ…Ø§Øª (Ø¬Ù„Ø³Ø© Ø¬Ø¯ÙŠØ¯Ø©)</button></div>
    <div style="margin-top:12px"><table class="table" id="weekly_table"><thead id="weekly_head"></thead><tbody id="weekly_body"></tbody></table></div>
  </section>

  <!-- Monthly -->
  <section id="monthly" class="card screen" style="display:none">
    <h3>Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø´Ù‡Ø±ÙŠ</h3>
    <label class="small">Ø§Ø®ØªØ± Ù…Ø¹Ù„Ù‘Ù…</label><select id="monthly_teacher"></select>
    <div id="monthly_wrap" style="margin-top:8px"></div>
    <div style="margin-top:8px"><button id="saveMonthly" class="btn">ØªØ³Ø¬ÙŠÙ„ Ø®ØµÙˆÙ…Ø§Øª (Ø¬Ù„Ø³Ø© Ø¬Ø¯ÙŠØ¯Ø©)</button></div>
    <div style="margin-top:12px"><table class="table" id="monthly_table"><thead id="monthly_head"></thead><tbody id="monthly_body"></tbody></table></div>
  </section>

  <!-- Attendance -->
  <section id="attendance" class="card screen" style="display:none">
    <h3>Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø§Ù†ØµØ±Ø§Ù</h3>
    <label class="small">Ø§Ø®ØªØ± Ù…Ø¹Ù„Ù‘Ù…</label><select id="attendance_teacher"></select>
    <div class="row" style="margin-top:8px"><div><label class="small">Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input id="att_date" type="date"></div><div><label class="small">ÙˆÙ‚Øª Ø§Ù„Ø­Ø¶ÙˆØ±</label><input id="att_arrival" type="time" value="07:00"></div><div><label class="small">ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØµØ±Ø§Ù</label><input id="att_leave" type="time" value="13:25"></div></div>
    <div style="margin-top:8px"><button id="saveAttendance" class="btn">Ø­ÙØ¸ (ÙŠØ­Ø³Ø¨ Ø§Ù„Ø®ØµÙ… ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§)</button> <button id="clearAttendance" class="btn ghost">Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button></div>
    <div style="margin-top:12px"><table class="table" id="attendance_table"><thead><tr><th>Ø§Ù„Ù…Ø¹Ù„Ù…</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø­Ø¶ÙˆØ±</th><th>Ø§Ù„Ø§Ù†ØµØ±Ø§Ù</th><th>ØªØ£Ø®Ø±</th><th>Ø§Ù†ØµØ±Ø§Ù Ù…Ø¨ÙƒØ±</th><th>Ø®ØµÙ…</th><th>Ø­Ø°Ù</th></tr></thead><tbody></tbody></table></div>
  </section>

  <!-- Absences -->
  <section id="absences" class="card screen" style="display:none">
    <h3>Ø§Ù„ØºÙŠØ§Ø¨</h3>
    <label class="small">Ø§Ø®ØªØ± Ù…Ø¹Ù„Ù‘Ù…</label><select id="absence_teacher"></select>
    <div class="row" style="margin-top:8px"><div><label class="small">Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input id="abs_date" type="date"></div><div><label class="small">Ø§Ù„Ù†ÙˆØ¹</label><select id="abs_type"><option value="excused">Ø¨Ø¹Ø°Ø±</option><option value="unexcused">Ø¨Ø¯ÙˆÙ† Ø¹Ø°Ø±</option></select></div><div id="abs_penalty_wrap" style="display:none"><label class="small">Ù‚ÙŠÙ…Ø© Ø§Ù„Ø®ØµÙ…</label><input id="abs_penalty" type="number" min="0" step="0.5"></div></div>
    <div style="margin-top:8px"><button id="saveAbsence" class="btn">Ø­ÙØ¸ Ø§Ù„ØºÙŠØ§Ø¨</button> <button id="clearAbsence" class="btn ghost">Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button></div>
    <div style="margin-top:12px"><table class="table" id="absence_table"><thead><tr><th>Ø§Ù„Ù…Ø¹Ù„Ù…</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø®ØµÙ…</th><th>Ø­Ø°Ù</th></tr></thead><tbody></tbody></table></div>
  </section>

  <!-- Summary Report (Ù…Ø±ØªÙ‘Ø¨ + ØªÙ…ÙŠÙŠØ² Ø§Ù„Ø«Ù„Ø§Ø«Ø© Ø§Ù„Ø£ÙˆØ§Ø¦Ù„) -->
  <section id="summaryReport" class="card screen" style="display:none">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
      <div>
        <div style="font-weight:900">ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ… â€“ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…</div>
        <div style="font-weight:900;font-size:18px;margin-top:6px">Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø®ØªØµØ± Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†</div>
        <div class="small" id="reportDate"></div>
      </div>
      <div style="display:flex;flex-direction:column;align-items:flex-end;gap:8px">
        <div class="export-row">
          <button id="exportPdf" class="btn">ğŸ“„ ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ PDF</button>
          <button id="exportExcel" class="btn">ğŸ“Š ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel</button>
          <button id="showChart" class="btn ghost">ğŸ“ˆ Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ</button>
        </div>
      </div>
    </div>

    <div style="margin-top:12px;overflow:auto">
      <table class="table" id="summary_table">
        <thead id="summary_head"></thead>
        <tbody id="summary_body"></tbody>
      </table>
      <div id="bestTeacher" class="highlight-best" style="display:none"></div>
    </div>
  </section>
  <!-- Full report -->
  <section id="fullReport" class="card screen" style="display:none">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="display:flex;gap:8px;align-items:center"><div class="logo-slot">Ø´Ø¹Ø§Ø±</div><div><div style="font-weight:900">ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ… â€“ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…</div><div style="font-weight:700">Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ø§Ù…Ù„</div></div></div>
      <div><button id="printFull" class="btn ghost">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button></div>
    </div>
    <div style="margin-top:12px"><table class="table" id="full_table"><thead id="full_head"></thead><tbody id="full_body"></tbody><tfoot id="full_foot"></tfoot></table></div>
  </section>

  <!-- Settings -->
  <section id="settings" class="card screen" style="display:none">
    <h3>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h3>
    <label class="small">Ø§Ù„Ø¯ÙˆØ§Ù… - Ø¨Ø¯Ø§ÙŠØ©</label><input id="official_start" type="time" value="07:00">
    <label class="small">Ø§Ù„Ø¯ÙˆØ§Ù… - Ù†Ù‡Ø§ÙŠØ©</label><input id="official_end" type="time" value="13:25">
    <label class="small">Ø£Ù‚ØµÙ‰ Ø®ØµÙ… Ù„Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø§Ù†ØµØ±Ø§Ù</label><input id="max_att" type="number" min="0" step="0.5" value="2">
    <div style="margin-top:12px"><button id="backup" class="btn">ğŸ’¾ Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</button> <button id="restore" class="btn ghost">ğŸ“‚ Ø§Ø³ØªØ¹Ø§Ø¯Ø©</button> <button id="resetAll" class="btn" style="background:var(--danger);color:#fff">Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button></div>
  </section>

  <!-- Chart area -->
  <section id="chartSection" class="card screen" style="display:none">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <div style="font-weight:900">ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ… â€“ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…</div>
        <div style="font-weight:900;font-size:18px;margin-top:6px">Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ â€” Ù…Ù‚Ø§Ø±Ù†Ø© Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† (Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ…)</div>
        <div class="small" id="chartDate"></div>
      </div>
      <div>
        <button id="backToSummary" class="btn ghost">â¬… Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
      </div>
    </div>
    <div class="canvas-wrap">
      <canvas id="teachersChart" height="220"></canvas>
    </div>
  </section>

  <div class="toast" id="toast"></div>
  <!-- Ù†Ø§ÙØ°Ø© ØªØ£ÙƒÙŠØ¯ Ø¹Ø§Ù…Ø© -->
  <div id="confirmModal" class="modal-backdrop">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalMessage">
      <div id="modalMessage" style="font-weight:700; font-size:1rem; margin-bottom:14px;">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ</div>
      <div style="display:flex; gap:10px; justify-content:flex-end;">
        <button id="modalOk" class="btn">Ù…ÙˆØ§ÙÙ‚</button>
        <button id="modalCancel" class="btn ghost">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </div>
  </div>
  
</div>

<!-- Ù…ÙƒØªØ¨Ø§Øª -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
/* Complete JS for index26_full.html â€” replaces previous script block.
   This is the robust version (based on index25 logic) with summary sorting + top3 coloring.
*/
(function(){
const STORAGE = 'index26_state_v1';
let state = {teachers:[], criteria:[], evaluations:[], deductions:[], attendance:[], absences:[], official:{start:'07:00', end:'13:25', maxAttendancePenalty:2}, ui:{sound:true}};

// DEFAULT criteria
const DEFAULT_CRITERIA = [
  {id:'c_daily_1',name:'Ø§Ù„Ø­Ø¶ÙˆØ±',kind:'daily',max:10,note:''},
  {id:'c_daily_2',name:'ØªÙ†Ø¸ÙŠÙ… Ø§Ù„Ø­ØµØ©',kind:'daily',max:10,note:''},
  {id:'c_week_1',name:'Ù…Ù†Ø§ÙˆØ¨Ø© Ø§Ù„ÙØ³Ø­Ø©',kind:'weekly',max:10,note:''},
  {id:'c_week_2',name:'Ù…Ù†Ø§ÙˆØ¨Ø© Ø§Ù„ØµÙ„Ø§Ø©',kind:'weekly',max:10,note:''},
  {id:'c_week_3',name:'Ø§Ù„ØªØ­Ø¶ÙŠØ±',kind:'weekly',max:10,note:''},
  {id:'c_month_1',name:'Ø§Ù„Ù…Ø®Ø±Ø¬Ø§Øª',kind:'monthly',max:10,note:''}
];

function save(){ localStorage.setItem(STORAGE, JSON.stringify(state)); }
function load(){ const raw = localStorage.getItem(STORAGE); if(raw){ try{ state = JSON.parse(raw); if(!Array.isArray(state.criteria) || state.criteria.length===0){ state.criteria = DEFAULT_CRITERIA.slice(); save(); } }catch(e){ state = {teachers:[], criteria: DEFAULT_CRITERIA.slice(), evaluations:[], deductions:[], attendance:[], absences:[], official:{start:'07:00', end:'13:25', maxAttendancePenalty:2}, ui:{sound:true}}; save(); } } else { state.criteria = DEFAULT_CRITERIA.slice(); save(); } }

function uid(p='id'){ return p + '_' + Date.now().toString(36) + Math.random().toString(36).slice(2,6); }
function toast(msg){ const t=document.getElementById('toast'); if(!t) return; t.textContent=msg; t.style.display='block'; setTimeout(()=> t.style.display='none',2200); }
function el(q){ return document.querySelector(q); }
function els(q){ return Array.from(document.querySelectorAll(q)); }
function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function minutesBetween(t1,t2){ if(!t1||!t2) return 0; const a=t1.split(':').map(Number); const b=t2.split(':').map(Number); return (b[0]*60+b[1]) - (a[0]*60+a[1]); }

/* NAV */
function bindNav(){ els('.nav-btn').forEach(b=> b.addEventListener('click', ()=>{ els('.nav-btn').forEach(x=>x.classList.remove('active')); b.classList.add('active'); show(b.dataset.screen); })); }
function show(id){ els('.screen').forEach(s=> s.style.display='none'); const elc=document.getElementById(id); if(elc) elc.style.display='block';
  if(id==='teachers') renderTeachers();
  if(id==='criteria') renderCriteria();
  if(id==='daily'){ renderCriteriaForKind('daily'); renderSessions('daily'); populateSelects(); }
  if(id==='weekly'){ renderCriteriaForKind('weekly'); renderSessions('weekly'); populateSelects(); }
  if(id==='monthly'){ renderCriteriaForKind('monthly'); renderSessions('monthly'); populateSelects(); }
  if(id==='attendance'){ renderAttendanceTable(); populateSelects(); }
  if(id==='absences'){ renderAbsences(); populateSelects(); }
  if(id==='summaryReport'){ renderSummaryReport(); populateSelects(); }
  if(id==='fullReport') renderFullReport();
  if(id==='settings') renderSettings();
  if(id==='chartSection'){ renderChartPage(); }
}

/* TEACHERS */
function renderTeachers(){ const tbody=el('#teachersTable tbody'); if(!tbody) return; tbody.innerHTML=''; state.teachers.forEach(t=>{ const tr=document.createElement('tr'); tr.innerHTML = `<td>${escapeHtml(t.name)}</td><td>${escapeHtml(t.id)}</td><td>${escapeHtml(t.subject||'')}</td><td><button class="btn ghost editTeacher" data-id="${t.id}">ØªØ¹Ø¯ÙŠÙ„</button> <button class="btn" data-id="${t.id}" data-act="delTeacher" style="background:var(--danger);color:#fff">Ø­Ø°Ù</button></td>`; tbody.appendChild(tr); }); els('.editTeacher').forEach(b=> b.addEventListener('click', e=> startEditTeacher(e.target.dataset.id))); els('[data-act="delTeacher"]').forEach(b=> b.addEventListener('click', async e=>{ const id=e.target.dataset.id; const ok = await confirmModal('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù…Ø¹Ù„Ù… ÙˆÙƒÙ„ Ø³Ø¬Ù„Ø§ØªÙ‡ØŸ'); if(!ok) return; deleteTeacher(id); })); }
function addTeacher(){ const name=el('#t_name').value.trim(); const id=el('#t_id').value.trim(); const subject=el('#t_subject').value.trim(); if(!name||!id){ alert('Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ù…Ø¹Ù„Ù…'); return; } if(state.teachers.some(t=>t.id===id)){ alert('Ø§Ù„Ø±Ù‚Ù… Ù…ÙˆØ¬ÙˆØ¯'); return; } state.teachers.push({id,name,subject}); save(); renderTeachers(); populateSelects(); el('#t_name').value=''; el('#t_id').value=''; el('#t_subject').value=''; toast('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ù„Ù…'); }
function startEditTeacher(id){ const t=state.teachers.find(x=>x.id===id); if(!t) return; el('#t_name').value=t.name; el('#t_id').value=t.id; el('#t_subject').value=t.subject||''; const btn=el('#addTeacher'); btn.textContent='Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„'; btn.onclick = ()=> saveEditTeacher(id); }
function saveEditTeacher(id){ const t=state.teachers.find(x=>x.id===id); if(!t) return; t.name=el('#t_name').value.trim(); t.subject=el('#t_subject').value.trim(); save(); renderTeachers(); populateSelects(); el('#addTeacher').textContent='Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„Ù‘Ù…'; el('#addTeacher').onclick = addTeacher; el('#t_name').value=''; el('#t_id').value=''; el('#t_subject').value=''; toast('ØªÙ… Ø§Ù„Ø­ÙØ¸'); }
function deleteTeacher(id){ state.teachers = state.teachers.filter(t=>t.id!==id); state.deductions = state.deductions.filter(d=> d.teacherId !== id); state.evaluations = state.evaluations.filter(e=> e.teacherId !== id); state.attendance = state.attendance.filter(a=> a.teacherId !== id); state.absences = state.absences.filter(a=> a.teacherId !== id); save(); renderTeachers(); populateSelects(); toast('ØªÙ… Ø§Ù„Ø­Ø°Ù'); }

/* CRITERIA */
function renderCriteria(){ const tbody = el('#ci_table tbody'); if(!tbody) return; tbody.innerHTML=''; (state.criteria||[]).forEach(c=>{ const tr=document.createElement('tr'); tr.innerHTML = `<td>${escapeHtml(c.name)}</td><td class="center">${c.max}</td><td>${escapeHtml(c.kind)}</td><td><button class="btn ghost editCi" data-id="${c.id}">ØªØ¹Ø¯ÙŠÙ„</button> <button class="btn" data-id="${c.id}" data-act="delCi" style="background:var(--danger);color:#fff">Ø­Ø°Ù</button></td>`; tbody.appendChild(tr); }); els('.editCi').forEach(b=> b.addEventListener('click', e=> startEditCi(e.target.dataset.id))); els('[data-act="delCi"]').forEach(b=> b.addEventListener('click', async e=>{ const id=e.target.dataset.id; const ok=await confirmModal('Ø­Ø°Ù Ø§Ù„Ø¨Ù†Ø¯ØŸ'); if(!ok) return; state.criteria = state.criteria.filter(x=> x.id!==id); save(); renderCriteria(); renderCriteriaForKind('daily'); renderCriteriaForKind('weekly'); renderCriteriaForKind('monthly'); })); }
function addCriterion(){ const name=el('#ci_name').value.trim(); const kind=el('#ci_kind').value; let max = Number(el('#ci_max').value); if(!name) return alert('Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ø¯'); if(!max || max<=0) max = 10; const id = uid('ci'); state.criteria.push({id,name,kind,max,note:''}); save(); el('#ci_name').value=''; el('#ci_max').value=10; el('#ci_kind').value='daily'; renderCriteria(); renderCriteriaForKind('daily'); renderCriteriaForKind('weekly'); renderCriteriaForKind('monthly'); populateSelects(); toast('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨Ù†Ø¯'); }
function startEditCi(id){ const c = state.criteria.find(x=> x.id===id); if(!c) return; el('#ci_name').value = c.name; el('#ci_max').value = c.max; el('#ci_kind').value = c.kind; const btn = el('#addCi'); btn.textContent='Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„'; btn.onclick = ()=> saveEditCi(id); }
function saveEditCi(id){ const c = state.criteria.find(x=> x.id===id); if(!c) return; c.name = el('#ci_name').value.trim(); c.max = Number(el('#ci_max').value) || c.max; c.kind = el('#ci_kind').value; save(); el('#addCi').textContent='â• Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯ Ø¬Ø¯ÙŠØ¯'; el('#ci_name').value=''; el('#ci_max').value=10; el('#ci_kind').value='daily'; renderCriteria(); renderCriteriaForKind('daily'); renderCriteriaForKind('weekly'); renderCriteriaForKind('monthly'); populateSelects(); toast('ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨Ù†Ø¯'); }
function restoreDefaults(){ const ok = confirm('Ø³ÙŠØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© (Ù„Ù† ÙŠØ¤Ø«Ø± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª). Ù…ØªØ§Ø¨Ø¹Ø©ØŸ'); if(!ok) return; state.criteria = DEFAULT_CRITERIA.slice(); save(); renderCriteria(); renderCriteriaForKind('daily'); renderCriteriaForKind('weekly'); renderCriteriaForKind('monthly'); populateSelects(); toast('ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©'); }

/* populate selects */
function populateSelects(){ ['daily_teacher','weekly_teacher','monthly_teacher','attendance_teacher','absence_teacher'].forEach(id=>{ const sel=el('#'+id); if(!sel) return; const prev=sel.value; sel.innerHTML=''; const ph = document.createElement('option'); ph.value=''; ph.textContent='-- Ø§Ø®ØªØ± --'; sel.appendChild(ph); state.teachers.forEach(t=>{ const o=document.createElement('option'); o.value=t.id; o.textContent = t.name + (t.subject?(' â€” '+t.subject):''); sel.appendChild(o); }); sel.value = prev; }); }

/* render criteria inputs for kind */
function renderCriteriaForKind(kind){ const wrap = el('#'+kind+'_wrap'); if(!wrap) return; wrap.innerHTML=''; const list = state.criteria.filter(c=> c.kind===kind); if(list.length===0){ wrap.innerHTML = '<div class="small">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ù†ÙˆØ¯</div>'; return; } list.forEach(ci=>{ const div=document.createElement('div'); div.style.display='flex'; div.style.justifyContent='space-between'; div.style.alignItems='center'; div.style.padding='8px'; div.style.marginBottom='6px'; div.style.borderRadius='6px'; div.style.background='#fffaf0'; div.innerHTML = `<div style="flex:1"><strong>${escapeHtml(ci.name)}</strong><div class="small">Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰: ${ci.max}</div></div><div style="display:flex;gap:8px;align-items:center"><input class="sess-input" data-id="${ci.id}" type="number" min="0" max="${ci.max}" value="0" style="width:100px"><button class="btn ghost viewDetails" data-id="${ci.id}" data-kind="${kind}">ØªÙØ§ØµÙŠÙ„</button></div>`; wrap.appendChild(div); }); // bind viewDetails
  wrap.querySelectorAll('.viewDetails').forEach(b=> b.addEventListener('click', e=>{ const sel = el('#'+e.target.dataset.kind+'_teacher'); if(!sel||!sel.value) return alert('Ø§Ø®ØªØ± Ù…Ø¹Ù„Ù…Ø§Ù‹'); showDeductionDetails(sel.value, e.target.dataset.id, e.target.dataset.kind); })); }

/* sessions/evaluations */
function addSession(kind){ const sel = el('#'+kind+'_teacher'); if(!sel||!sel.value) return alert('Ø§Ø®ØªØ± Ù…Ø¹Ù„Ù…Ø§Ù‹'); const teacherId = sel.value; const inputs = Array.from(document.querySelectorAll('#'+kind+'_wrap .sess-input')); const map={}; inputs.forEach(i=> map[i.dataset.id] = Number(i.value)||0); const addedIds=[]; Object.entries(map).forEach(([cid,val])=>{ if(val>0){ const rec = {id:uid('ded'), teacherId, criteriaId:cid, kind, date:new Date().toISOString(), deduction: val, note:''}; state.deductions.push(rec); addedIds.push(rec.id); } }); if(addedIds.length===0) return alert('Ù„Ù… ØªØ¯Ø®Ù„ Ø£ÙŠ Ø®ØµÙ…'); state.evaluations.push({id:uid('sess'), teacherId, kind, date:new Date().toISOString(), deductionIds: addedIds}); save(); renderSessions(kind); toast('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø¬Ù„Ø³Ø© ÙˆØ®ØµÙˆÙ…Ø§Øª'); inputs.forEach(i=> i.value=0); }
function renderSessions(kind){ const head = el('#'+kind+'_head'); const body = el('#'+kind+'_body'); if(!head||!body) return; head.innerHTML=''; body.innerHTML=''; const crits = state.criteria.filter(c=> c.kind===kind); const trh=document.createElement('tr'); trh.innerHTML = '<th>Ø§Ù„Ù…Ø¹Ù„Ù…</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>'; crits.forEach(c=> trh.innerHTML += `<th>${escapeHtml(c.name)}</th>`); trh.innerHTML += '<th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th><th>Ø­Ø°Ù</th>'; head.appendChild(trh); const rows = state.evaluations.filter(s=> s.kind===kind); rows.forEach(r=>{ const tr=document.createElement('tr'); const t = state.teachers.find(x=>x.id===r.teacherId) || {name:'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}; let inner = `<td>${escapeHtml(t.name)}</td><td>${new Date(r.date).toLocaleString()}</td>`; let total=0; crits.forEach(c=>{ const totalDed = state.deductions.filter(d=> d.teacherId===r.teacherId && d.criteriaId===c.id && d.kind===kind).reduce((s,it)=> s+Number(it.deduction||0),0); const final = Math.max(0, c.max - totalDed); inner += `<td class="center">${final}<div class="small">(-${totalDed})</div></td>`; total += final; }); inner += `<td class="center">${total}</td><td class="center"><button class="btn" data-id="${r.id}" data-kind="${kind}" style="background:var(--danger);color:#fff">Ø­Ø°Ù</button></td>`; tr.innerHTML = inner; body.appendChild(tr); }); body.querySelectorAll('button[data-kind]').forEach(b=> b.addEventListener('click', async e=>{ const id=e.target.dataset.id; const ok = await confirmModal('Ø­Ø°Ù Ø§Ù„Ø¬Ù„Ø³Ø©ØŸ'); if(!ok) return; const sess = state.evaluations.find(s=>s.id===id); if(sess && sess.deductionIds) state.deductions = state.deductions.filter(d=> !sess.deductionIds.includes(d.id)); state.evaluations = state.evaluations.filter(s=> s.id!==id); save(); renderSessions(e.target.dataset.kind); toast('ØªÙ… Ø§Ù„Ø­Ø°Ù'); })); }

/* deduction details */
function showDeductionDetails(teacherId, criteriaId, kind){ const items = state.deductions.filter(d=> d.teacherId===teacherId && d.criteriaId===criteriaId && d.kind===kind).sort((a,b)=> new Date(b.date)-new Date(a.date)); let msg = ''; if(items.length===0) msg = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø®ØµÙˆÙ…Ø§Øª'; else items.forEach(it=> msg += `${new Date(it.date).toLocaleString()} â€” ${it.deduction}\n`); alert(msg); }

/* attendance */
function saveAttendance(){ const sel=el('#attendance_teacher'); if(!sel||!sel.value) return alert('Ø§Ø®ØªØ± Ù…Ø¹Ù„Ù…Ø§Ù‹'); const date=el('#att_date').value; if(!date) return alert('Ø§Ø®ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ®'); const arrival=el('#att_arrival').value; const leave=el('#att_leave').value; const officialStart = el('#official_start').value || state.official.start; const officialEnd = el('#official_end').value || state.official.end; const late = Math.max(0, minutesBetween(officialStart, arrival)); const early = Math.max(0, minutesBetween(leave, officialEnd)); const total = late + early; const steps = Math.floor(total/30); let ded = steps * 0.5; const cap = Number(el('#max_att').value) || state.official.maxAttendancePenalty || 2; if(ded>cap) ded = cap; const rec = {id:uid('att'), teacherId: sel.value, date, arrival, leave, late, early, deduction: ded}; state.attendance.push(rec); if(ded>0) state.deductions.push({id:uid('ded'), teacherId: sel.value, criteriaId:'attendance_auto', kind:'attendance', date:new Date().toISOString(), deduction: ded, note:`ØªØ£Ø®Ø± ${late}Ø¯ Ø§Ù†ØµØ±Ø§Ù ${early}Ø¯`}); save(); renderAttendanceTable(); toast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø®ØµÙ…'); }
function renderAttendanceTable(){ const tbody=el('#attendance_table tbody'); if(!tbody) return; tbody.innerHTML=''; state.attendance.forEach(a=>{ const t = state.teachers.find(tt=>tt.id===a.teacherId) || {name:'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}; const tr=document.createElement('tr'); tr.innerHTML = `<td>${escapeHtml(t.name)}</td><td>${a.date}</td><td class="center">${a.arrival}</td><td class="center">${a.leave}</td><td class="center">${a.late}</td><td class="center">${a.early}</td><td class="center">${a.deduction||0}</td><td class="center"><button class="btn ghost delAtt" data-id="${a.id}">Ø­Ø°Ù</button></td>`; tbody.appendChild(tr); }); els('.delAtt').forEach(b=> b.addEventListener('click', async e=>{ const id=e.target.dataset.id; const ok = await confirmModal('Ø­Ø°Ù Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ±ØŸ'); if(!ok) return; const rec = state.attendance.find(x=>x.id===id); if(rec){ state.deductions = state.deductions.filter(d=> !(d.teacherId===rec.teacherId && d.kind==='attendance' && d.date.slice(0,10)===new Date(rec.date).toISOString().slice(0,10))); } state.attendance = state.attendance.filter(x=> x.id!==id); save(); renderAttendanceTable(); toast('ØªÙ… Ø§Ù„Ø­Ø°Ù'); })); }

/* absences */
function bindAbsTypeChange(){ const absType = el('#abs_type'); if(!absType) return; absType.addEventListener('change', e=>{ el('#abs_penalty_wrap').style.display = e.target.value==='unexcused' ? 'block':'none'; }); }
function saveAbsence(){ const sel=el('#absence_teacher'); if(!sel||!sel.value) return alert('Ø§Ø®ØªØ± Ù…Ø¹Ù„Ù…Ø§Ù‹'); const date=el('#abs_date').value; if(!date) return alert('Ø§Ø®ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ®'); const type=el('#abs_type').value; let penalty=0; if(type==='unexcused') penalty = Number(el('#abs_penalty').value)||0; const rec = {id:uid('abs'), teacherId: sel.value, date, type, penalty}; state.absences.push(rec); if(type==='unexcused' && penalty>0) state.deductions.push({id:uid('ded'), teacherId: sel.value, criteriaId:'absence_auto', kind:'absence', date:new Date().toISOString(), deduction: penalty, note:'ØºÙŠØ§Ø¨ Ø¨Ø¯ÙˆÙ† Ø¹Ø°Ø±'}); save(); renderAbsences(); toast('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØºÙŠØ§Ø¨'); }
function renderAbsences(){ const tbody=el('#absence_table tbody'); if(!tbody) return; tbody.innerHTML=''; state.absences.forEach(a=>{ const t= state.teachers.find(tt=>tt.id===a.teacherId) || {name:'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}; const tr=document.createElement('tr'); tr.innerHTML = `<td>${escapeHtml(t.name)}</td><td>${a.date}</td><td>${a.type}</td><td class="center">${a.penalty||0}</td><td class="center"><button class="btn ghost delAbs" data-id="${a.id}">Ø­Ø°Ù</button></td>`; tbody.appendChild(tr); }); els('.delAbs').forEach(b=> b.addEventListener('click', async e=>{ const id=e.target.dataset.id; const ok = await confirmModal('Ø­Ø°Ù Ø³Ø¬Ù„ Ø§Ù„ØºÙŠØ§Ø¨ØŸ'); if(!ok) return; const rec = state.absences.find(x=>x.id===id); if(rec && rec.penalty>0){ state.deductions = state.deductions.filter(d=> !(d.teacherId===rec.teacherId && d.kind==='absence' && d.date.slice(0,10)===new Date(rec.date).toISOString().slice(0,10))); } state.absences = state.absences.filter(x=> x.id!==id); save(); renderAbsences(); toast('ØªÙ… Ø§Ù„Ø­Ø°Ù'); })); }

/* full report */
function renderFullReport(){ const head=el('#full_head'); const body=el('#full_body'); const foot=el('#full_foot'); if(!head) return; head.innerHTML=''; body.innerHTML=''; foot.innerHTML=''; const crits = state.criteria || []; let h = '<tr><th>Ø§Ù„Ù…Ø¹Ù„Ù…</th><th>Ø§Ù„Ø±Ù‚Ù…</th>'; crits.forEach(c=> h += `<th>${escapeHtml(c.name)}</th><th>Ù…Ø¬Ù…ÙˆØ¹ Ø®ØµÙ…</th><th>Ù†Ø§ØªØ¬</th><th>Ù…Ù„Ø§Ø­Ø¸Ø©</th>`); h += '<th>Ø®ØµÙ… Ø§Ù„ØºÙŠØ§Ø¨</th><th>Ø®ØµÙ… Ø§Ù„Ø­Ø¶ÙˆØ±</th><th>Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</th></tr>'; head.innerHTML = h; state.teachers.forEach(t=>{ let row = `<tr><td>${escapeHtml(t.name)}</td><td>${escapeHtml(t.id)}</td>`; let sumBonds=0; crits.forEach(c=>{ const items = state.deductions.filter(d=> d.teacherId===t.id && d.criteriaId===c.id && d.kind===c.kind); const totalDed = items.reduce((s,i)=> s + Number(i.deduction||0),0); const final = Math.max(0, c.max - totalDed); const note = items.length? items[items.length-1].note || '-' : '-'; row += `<td class="center">${c.max}</td><td class="center">${totalDed}</td><td class="center">${final}</td><td>${escapeHtml(note)}</td>`; sumBonds += final; }); const absenceSum = state.deductions.filter(d=> d.teacherId===t.id && d.kind==='absence').reduce((s,i)=> s + Number(i.deduction||0),0); const attendanceSum = state.deductions.filter(d=> d.teacherId===t.id && d.kind==='attendance').reduce((s,i)=> s + Number(i.deduction||0),0); const finalScore = Math.max(0, sumBonds - (absenceSum + attendanceSum)); row += `<td class="center">${absenceSum}</td><td class="center">${attendanceSum}</td><td class="center">${finalScore}</td></tr>`; body.innerHTML += row; }); // footer
  const allMax = state.criteria.reduce((s,c)=> s + Number(c.max||0),0); const totalDeductions = state.deductions.reduce((s,d)=> s + Number(d.deduction||0),0); const allFinals = state.teachers.reduce((s,t)=> { const sumBonds = state.criteria.reduce((a,c)=> a + Math.max(0, c.max - state.deductions.filter(d=> d.teacherId===t.id && d.criteriaId===c.id && d.kind===c.kind).reduce((x,y)=> x + Number(y.deduction||0),0)),0); const absenceSum = state.deductions.filter(d=> d.teacherId===t.id && d.kind==='absence').reduce((x,y)=> x + Number(y.deduction||0),0); const attendanceSum = state.deductions.filter(d=> d.teacherId===t.id && d.kind==='attendance').reduce((x,y)=> x + Number(y.deduction||0),0); return s + Math.max(0, sumBonds - (absenceSum + attendanceSum)); },0); const tr=document.createElement('tr'); tr.className='full-gold'; tr.innerHTML = `<td colspan="${2 + (state.criteria.length*4) + 3}" style="text-align:left;padding:12px"><strong>Ù…Ù„Ø®Øµ Ø°Ù‡Ø¨ÙŠ:</strong> Ø¹Ø¯Ø¯ Ø§Ù„Ø¨Ù†ÙˆØ¯: <strong>${state.criteria.length}</strong> | Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù‚ØµÙˆÙ‰: <strong>${allMax}</strong> | Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª Ø§Ù„ÙƒÙ„ÙŠØ©: <strong>${totalDeductions}</strong> | Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: <strong>${allFinals}</strong></td>`; foot.appendChild(tr); }

/* SUMMARY (Ø±ØªÙ‘Ø¨ ÙˆÙ…ÙŠÙ‘Ø² Ø§Ù„Ø«Ù„Ø§Ø«Ø© Ø§Ù„Ø£ÙˆØ§Ø¦Ù„) */
function computeTeacherSummary(){
  const crits = state.criteria || [];
  const totalPossible = crits.reduce((s,c)=> s + Number(c.max||0),0);
  const rows = state.teachers.map(t=>{
    const perCriterion = crits.map(c=>{
      const items = state.deductions.filter(d=> d.teacherId===t.id && d.criteriaId===c.id && d.kind===c.kind);
      const totalDed = items.reduce((s,i)=> s + Number(i.deduction||0),0);
      const final = Math.max(0, c.max - totalDed);
      return {id:c.id,name:c.name,max:c.max,totalDed,final,kind:c.kind};
    });
    const sumCriteriaFinals = perCriterion.reduce((s,it)=> s + it.final, 0);
    const absenceSum = state.deductions.filter(d=> d.teacherId===t.id && d.kind==='absence').reduce((s,i)=> s + Number(i.deduction||0),0);
    const attendanceSum = state.deductions.filter(d=> d.teacherId===t.id && d.kind==='attendance').reduce((s,i)=> s + Number(i.deduction||0),0);
    const totalAfterPenalties = Math.max(0, sumCriteriaFinals - (absenceSum + attendanceSum));
    const percent = totalPossible ? ( (totalAfterPenalties / totalPossible) * 100 ) : 0;
    return {teacher: t, perCriterion, absenceSum, attendanceSum, sumCriteriaFinals, totalAfterPenalties, percent, totalPossible};
  });
  return {crits, rows, totalPossible};
}

function renderSummaryReport(){
  const head = el('#summary_head');
  const body = el('#summary_body');
  if(!head) return;
  el('#reportDate').textContent = 'ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ±: ' + (new Date()).toLocaleDateString();
  head.innerHTML = ''; body.innerHTML = '';
  const {crits, rows, totalPossible} = computeTeacherSummary();
  // header
  let h = '<tr><th>Ø§Ù„Ù…Ø¹Ù„Ù…</th><th>Ø§Ù„ØªØ®ØµØµ</th>';
  crits.forEach(c=> h += `<th>${escapeHtml(c.name)}</th>`);
  h += `<th>Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø§Ù†ØµØ±Ø§Ù</th><th>Ø§Ù„ØºÙŠØ§Ø¨</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ…</th><th>Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ©</th></tr>`;
  head.innerHTML = h;
  // ØªØ±ØªÙŠØ¨ ØªÙ†Ø§Ø²Ù„ÙŠ Ø­Ø³Ø¨ totalAfterPenalties
  const sorted = rows.slice().sort((a,b)=> b.totalAfterPenalties - a.totalAfterPenalties);
  sorted.forEach((r, index)=>{
    let bg = '';
    if(index === 0) bg = 'style="background:#fff6cc"'; // Ø°Ù‡Ø¨ÙŠ
    else if(index === 1) bg = 'style="background:#f0f0f0"'; // ÙØ¶ÙŠ
    else if(index === 2) bg = 'style="background:#ffe0b3"'; // Ø¨Ø±ÙˆÙ†Ø²ÙŠ
    let row = `<tr ${bg}><td>${escapeHtml(r.teacher.name)}</td><td>${escapeHtml(r.teacher.subject||'-')}</td>`;
    r.perCriterion.forEach(p=> row += `<td class="center">${p.final}<div class="small">(-${p.totalDed})</div></td>`);
    row += `<td class="center">${r.attendanceSum}</td><td class="center">${r.absenceSum}</td>`;
    row += `<td class="center">${r.totalAfterPenalties}</td><td class="center">${r.percent.toFixed(1)}%</td></tr>`;
    body.innerHTML += row;
  });
  const bestEl = el('#bestTeacher');
  if(bestEl){
    if(sorted.length===0){ bestEl.style.display='none'; }
    else { const best = sorted[0]; bestEl.style.display='block'; bestEl.innerHTML = `ğŸ… Ø£ÙØ¶Ù„ Ù…Ø¹Ù„Ù…: <strong>${escapeHtml(best.teacher.name)}</strong> â€” Ù†ØªÙŠØ¬Ø© Ù†Ù‡Ø§Ø¦ÙŠØ©: <strong>${best.totalAfterPenalties}</strong> â€” (${best.percent.toFixed(1)}%)`; }
  }
}

/* CHART */
let chartInstance = null;
function renderChartPage(){
  el('#chartDate').textContent = 'ØªØ§Ø±ÙŠØ®: ' + (new Date()).toLocaleDateString();
  const {rows, totalPossible} = computeTeacherSummary();
  const labels = rows.map(r=> r.teacher.name);
  const data = rows.map(r=> r.totalAfterPenalties);
  const ctx = document.getElementById('teachersChart') && document.getElementById('teachersChart').getContext('2d');
  if(!ctx) return;
  if(chartInstance) chartInstance.destroy();
  chartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: 'Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ…',
        data,
        backgroundColor: labels.map((_,i)=> 'rgba(246,180,88,0.95)'),
        borderColor: labels.map((_,i)=> 'rgba(255,138,0,0.95)'),
        borderWidth: 1
      }]
    },
    options: {
      indexAxis: 'x',
      responsive:true,
      plugins:{
        legend:{display:false},
        tooltip:{callbacks:{ label: (ctx) => {
          const val = ctx.parsed.y ?? ctx.parsed;
          const percent = totalPossible ? ((val/totalPossible)*100).toFixed(1) + '%' : '-';
          return ` ${val} â€” ${percent}`;
        }}},
        datalabels:{
          color:'#3b2300',
          anchor:'end',
          align:'start',
          formatter: (value, context) => {
            const percent = totalPossible ? ((value/totalPossible)*100).toFixed(1) + '%' : '';
            return value + (percent ? ('\n' + percent) : '');
          },
          font: { weight: '700' }
        }
      },
      scales:{
        y:{ beginAtZero:true, title:{display:true, text:'Ø§Ù„Ø¯Ø±Ø¬Ø§Øª'} }
      }
    },
    plugins: [ChartDataLabels]
  });
  els('.nav-btn').forEach(x=>x.classList.remove('active'));
  els('.screen').forEach(s=> s.style.display='none');
  el('#chartSection').style.display = 'block';
  window.scrollTo({ top: el('#chartSection').offsetTop - 10, behavior: 'smooth' });
}

/* EXPORTS (Excel/PDF) */
function exportSummaryToExcel(){
  const computed = computeTeacherSummary();
  const wb = XLSX.utils.book_new();
  const headers = ['Ø§Ù„Ù…Ø¹Ù„Ù…','Ø§Ù„ØªØ®ØµØµ', ...computed.crits.map(c=> c.name), 'Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø§Ù†ØµØ±Ø§Ù','Ø§Ù„ØºÙŠØ§Ø¨','Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ…','Ø§Ù„Ù†Ø³Ø¨Ø© (%)'];
  const aoa = [headers];
  computed.rows.forEach(r=>{
    const row = [r.teacher.name, r.teacher.subject || '-'];
    r.perCriterion.forEach(p=> row.push(p.final));
    row.push(r.attendanceSum, r.absenceSum, r.totalAfterPenalties, r.percent.toFixed(1));
    aoa.push(row);
  });
  const ws = XLSX.utils.aoa_to_sheet(aoa);
  XLSX.utils.book_append_sheet(wb, ws, 'Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø®ØªØµØ±');
  XLSX.writeFile(wb, 'summary_report.xlsx');
  toast('ØªÙ… ØªÙ†Ø²ÙŠÙ„ Ù…Ù„Ù Excel');
}

async function exportSummaryToPDF(){
  const elToPrint = el('#summaryReport');
  if(!elToPrint) return;
  const prevDisplay = elToPrint.style.display;
  elToPrint.style.display = 'block';
  const clone = elToPrint.cloneNode(true);
  clone.style.width = '1000px';
  clone.style.padding = '20px';
  clone.querySelectorAll('button').forEach(b=> b.remove());
  document.body.appendChild(clone);
  const canvas = await html2canvas(clone, {scale:2});
  const imgData = canvas.toDataURL('image/png');
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({orientation:'portrait', unit:'pt', format:'a4'});
  const pageWidth = pdf.internal.pageSize.getWidth();
  const imgProps = pdf.getImageProperties(imgData);
  const imgW = pageWidth - 40;
  const imgH = (imgProps.height * imgW) / imgProps.width;
  pdf.addImage(imgData, 'PNG', 20, 20, imgW, imgH);
  pdf.save('summary_report.pdf');
  document.body.removeChild(clone);
  elToPrint.style.display = prevDisplay;
  toast('ØªÙ… ØªÙ†Ø²ÙŠÙ„ Ù…Ù„Ù PDF');
}

/* modal confirm */
function confirmModal(msg){ return new Promise(res=>{ const md=document.getElementById('confirmModal'); if(!md) return res(false); document.getElementById('modalMessage').textContent=msg; md.style.display='flex'; const ok=document.getElementById('modalOk'), cancel=document.getElementById('modalCancel'); function cleanup(){ md.style.display='none'; ok.removeEventListener('click',onok); cancel.removeEventListener('click',oncancel); } function onok(){ cleanup(); res(true); } function oncancel(){ cleanup(); res(false); } ok.addEventListener('click', onok); cancel.addEventListener('click', oncancel); }); }

/* backup restore reset */
function doBackup(){ const blob = new Blob([JSON.stringify(state,null,2)],{type:'application/json'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='index26_backup.json'; a.click(); URL.revokeObjectURL(url); toast('ØªÙ… ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©'); }
function doRestore(){ const inp=document.createElement('input'); inp.type='file'; inp.accept='application/json'; inp.onchange = e=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload = ev=>{ try{ const obj = JSON.parse(ev.target.result); if(obj && Array.isArray(obj.teachers)){ state = obj; save(); location.reload(); } else alert('Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­'); }catch(err){ alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ù„Ù'); } }; r.readAsText(f); }; inp.click(); }
async function doReset(){ const ok = await confirmModal('Ø³ÙŠØªÙ… Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ù…ÙˆØ§ÙÙ‚ØŸ'); if(!ok) return; state = {teachers:[], criteria: DEFAULT_CRITERIA.slice(), evaluations:[], deductions:[], attendance:[], absences:[], official:{start:'07:00', end:'13:25', maxAttendancePenalty:2}, ui:{sound:true}}; save(); location.reload(); }

/* IMPORT Excel/CSV */
function importTeachersFile(file){
  const name = (file.name || '').toLowerCase();
  if(name.endsWith('.csv')){
    const reader = new FileReader();
    reader.onload = (e) => {
      // parse CSV using XLSX
      const workbook = XLSX.read(e.target.result, {type:'string', raw:true});
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      processSheetRows(sheet);
    };
    reader.readAsText(file, 'utf-8');
  } else {
    const reader = new FileReader();
    reader.onload = (e) => {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: 'array' });
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      processSheetRows(sheet);
    };
    reader.readAsArrayBuffer(file);
  }
}

function processSheetRows(sheet){
  if(!sheet){ alert('Ø§Ù„Ù…Ù„Ù ÙØ§Ø±Øº Ø£Ùˆ ØºÙŠØ± ØµØ§Ù„Ø­'); return; }
  const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
  if(!rows || rows.length===0){ alert('Ø§Ù„Ù…Ù„Ù Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª'); return; }
  const headers = rows[0].map(h => String(h||'').trim());
  const nameIdx = headers.findIndex(h => ['Ø§Ù„Ø§Ø³Ù…','name'].includes(h.toLowerCase()));
  const idIdx = headers.findIndex(h => ['Ø§Ù„Ø±Ù‚Ù…','id','Ø±Ù‚Ù…'].includes(h.toLowerCase()));
  const subjIdx = headers.findIndex(h => ['Ø§Ù„Ù…Ø§Ø¯Ø©','subject','Ø§Ù„Ù…ÙˆØ§Ø¯'].includes(h.toLowerCase()));
  if(nameIdx===-1 || idIdx===-1){
    alert('ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø§Ù„Ù…Ù„Ù Ø¹Ù„Ù‰ Ø¹Ù…ÙˆØ¯ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„: Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø±Ù‚Ù… (Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©: Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ø±Ù‚Ù…ØŒ Ø§Ù„Ù…Ø§Ø¯Ø©)');
    return;
  }
  let added = 0, skipped = 0;
  for(let i=1;i<rows.length;i++){
    const r = rows[i];
    if(!r) continue;
    const name = (r[nameIdx] || '').toString().trim();
    const id = (r[idIdx] || '').toString().trim();
    const subj = subjIdx!==-1 ? (r[subjIdx] || '').toString().trim() : '';
    if(!name || !id){ skipped++; continue; }
    if(state.teachers.some(t=> String(t.id).trim() === String(id).trim())){ skipped++; continue; }
    state.teachers.push({id:String(id), name, subject: subj});
    added++;
  }
  save();
  renderTeachers();
  populateSelects();
  toast(`ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${added} Ù…Ø¹Ù„Ù… â€” ØªÙ… ØªØ®Ø·ÙŠ ${skipped} Ø³Ø¬Ù„Ø§Ù‹`);
}

/* init & bindings */
function init(){
  load();
  if(!state.criteria || state.criteria.length===0) state.criteria = DEFAULT_CRITERIA.slice();
  bindNav();
  // basic bindings
  el('#addTeacher') && el('#addTeacher').addEventListener('click', addTeacher);
  el('#addCi') && el('#addCi').addEventListener('click', addCriterion);
  el('#restoreDefaults') && el('#restoreDefaults').addEventListener('click', restoreDefaults);
  el('#saveDaily') && el('#saveDaily').addEventListener('click', ()=> addSession('daily'));
  el('#saveWeekly') && el('#saveWeekly').addEventListener('click', ()=> addSession('weekly'));
  el('#saveMonthly') && el('#saveMonthly').addEventListener('click', ()=> addSession('monthly'));
  el('#saveAttendance') && el('#saveAttendance').addEventListener('click', saveAttendance);
  el('#clearAttendance') && el('#clearAttendance').addEventListener('click', async ()=>{ const ok=await confirmModal('Ù…Ø³Ø­ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ±ØŸ'); if(!ok) return; state.attendance=[]; state.deductions = state.deductions.filter(d=> d.kind!=='attendance'); save(); renderAttendanceTable(); });
  el('#saveAbsence') && el('#saveAbsence').addEventListener('click', saveAbsence);
  el('#clearAbsence') && el('#clearAbsence').addEventListener('click', async ()=>{ const ok=await confirmModal('Ù…Ø³Ø­ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØºÙŠØ§Ø¨ØŸ'); if(!ok) return; state.absences=[]; state.deductions = state.deductions.filter(d=> d.kind!=='absence'); save(); renderAbsences(); });
  el('#backup') && el('#backup').addEventListener('click', doBackup);
  el('#backupTop') && el('#backupTop').addEventListener('click', doBackup);
  el('#restore') && el('#restore').addEventListener('click', doRestore);
  el('#printFull') && el('#printFull').addEventListener('click', ()=> window.print());
  el('#resetAll') && el('#resetAll').addEventListener('click', doReset);
  el('#official_start') && el('#official_start').addEventListener('change', e=>{ state.official.start = e.target.value; save(); });
  el('#official_end') && el('#official_end').addEventListener('change', e=>{ state.official.end = e.target.value; save(); });
  el('#max_att') && el('#max_att').addEventListener('change', e=>{ state.official.maxAttendancePenalty = Number(e.target.value)||2; save(); toast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯'); });

  // summary bindings
  el('#exportExcel') && el('#exportExcel').addEventListener('click', exportSummaryToExcel);
  el('#exportPdf') && el('#exportPdf').addEventListener('click', ()=> exportSummaryToPDF().catch(e=> { console.error(e); alert('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ PDF'); }));
  el('#showChart') && el('#showChart').addEventListener('click', ()=> { renderChartPage(); });
  el('#backToSummary') && el('#backToSummary').addEventListener('click', ()=> { show('summaryReport'); window.scrollTo({top:0, behavior: 'smooth'}); });

  // IMPORT bindings (Excel/CSV)
  el('#btnImportFile') && el('#btnImportFile').addEventListener('click', ()=> el('#importFile').click());
  el('#importFile') && el('#importFile').addEventListener('change', e=> {
    const f = e.target.files[0];
    if(!f) return;
    importTeachersFile(f);
    e.target.value = '';
  });

  // other binds
  bindAbsTypeChange();

  // initial render
  renderTeachers(); renderCriteria(); renderCriteriaForKind('daily'); renderCriteriaForKind('weekly'); renderCriteriaForKind('monthly');
  populateSelects();
  renderSessions('daily'); renderSessions('weekly'); renderSessions('monthly');
  renderAttendanceTable(); renderAbsences(); renderFullReport(); renderSettings();

  // default screen
  const navBtns = els('.nav-btn');
  navBtns.forEach(b=> b.classList.remove('active'));
  const first = document.querySelector('.nav-btn[data-screen="teachers"]');
  if(first) first.classList.add('active');
  show('teachers');

  toast('Ø§Ù„Ø¥ØµØ¯Ø§Ø± 26 Ø¬Ø§Ù‡Ø² â€” ØªÙ… ØªØµØ­ÙŠØ­ Ø§Ù„Ø³ÙƒØ±Ø¨Øª');
}

function renderSettings(){ if(!el('#official_start')) return; el('#official_start').value = state.official.start || '07:00'; el('#official_end').value = state.official.end || '13:25'; el('#max_att').value = state.official.maxAttendancePenalty || 2; }

document.addEventListener('DOMContentLoaded',init);
})(); 
</script>

</body>
</html>
